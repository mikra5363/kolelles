<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ - ××ª×¨ ×”××©×¤×—×•×ª</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        /* ×˜×¤×¡×™ ×”×¨×©××” ×•×›× ×™×¡×” */
        .auth-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 25px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .form-toggle button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .form-toggle button.active {
            background: #4CAF50;
            color: white;
        }

        .auth-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        /* ×××©×§ ×”××©×¤×—×” */
        .family-dashboard {
            display: none;
        }

        .user-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info h2 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .family-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .family-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .family-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .family-number {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .parents-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .parent-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .parent-card.father {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .parent-card.mother {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        }

        .parent-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .parent-details {
            font-size: 14px;
            color: #666;
        }

        .children-section {
            margin-top: 20px;
        }

        .children-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .children-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .add-child-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .children-list {
            display: grid;
            gap: 10px;
        }

        .child-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
        }

        .child-item.pending {
            background: #fff8e1;
            border-color: #ffa000;
            opacity: 0.7;
        }

        .child-item.approved {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .child-info {
            flex: 1;
        }

        .child-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .child-details {
            font-size: 12px;
            color: #666;
        }

        .child-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        /* ××•×“×œ ×”×•×¡×¤×ª ×™×œ×“ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* ×”×•×“×¢×•×ª */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ×˜×¢×™× ×” */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ×¨×¡×¤×•× ×¡×™×‘ */
        @media (max-width: 768px) {
            .parents-section {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .children-header {
                flex-direction: column;
                gap: 10px;
            }

            .child-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* ×¡×˜×˜×•×¡ ×—×™×‘×•×¨ */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.loading {
            background: #ff9800;
            color: white;
        }

        /* ×œ×—×¦×Ÿ ×”×¤× ×™×” ×œ×”×¨×©××” */
        .redirect-to-register {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
        }

        .redirect-to-register:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status loading">ğŸ”„ ××ª×—×‘×¨...</div>

    <div class="container">
        <div class="header">
            <h1>ğŸ  ×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ</h1>
            <p>××ª×¨ ×”××©×¤×—×•×ª ×”×¨×©××™ - ×¦×¤×™×” ×‘××©×¤×—×” ×•×”×•×¡×¤×ª ×™×œ×“×™×</p>
        </div>

        <div class="content">
            <!-- ××¡×š ×”×¨×©××” ×•×›× ×™×¡×” -->
            <div id="authSection" class="auth-container">
                <!-- ×›×¤×ª×•×¨×™ ×”×—×œ×¤×” -->
                <div class="form-toggle">
                    <button id="loginTab" class="active" onclick="showLoginForm()">×›× ×™×¡×”</button>
                    <button id="registerTab" onclick="showRegisterForm()">×”×¨×©××”</button>
                </div>

                <!-- ×˜×•×¤×¡ ×›× ×™×¡×” -->
                <div id="loginForm" class="auth-form">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
                    
                    <div class="form-group">
                        <label>××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª</label>
                        <input type="text" id="loginId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                        <input type="tel" id="loginPhone" placeholder="050-1234567" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="loginUser()">
                        ğŸšª ×›× ×™×¡×” ×œ××¢×¨×›×ª
                    </button>

                    <div id="loginMessage"></div>
                </div>

                <!-- ×˜×•×¤×¡ ×”×¨×©××” -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ ×”×¨×©××” ×—×“×©×”</h2>
                    
                    <div class="form-group">
                        <label>×©× ×¤×¨×˜×™ *</label>
                        <input type="text" id="regFirstName" required>
                    </div>

                    <div class="form-group">
                        <label>×©× ××©×¤×—×” *</label>
                        <input type="text" id="regLastName" required>
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª *</label>
                        <input type="text" id="regId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>×©× ×”××‘ *</label>
                        <input type="text" id="regFatherName" required>
                    </div>

                    <div class="form-group">
                        <label>×©× ×”×× *</label>
                        <input type="text" id="regMotherName" required>
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×˜×œ×¤×•×Ÿ *</label>
                        <input type="tel" id="regPhone" placeholder="050-1234567" required>
                    </div>

                    <div class="form-group">
                        <label>×›×ª×•×‘×ª ××™×™×œ *</label>
                        <input type="email" id="regEmail" placeholder="example@email.com" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="registerUser()">
                        ğŸ“§ ×©×œ×— ×‘×§×©×ª ×”×¨×©××”
                    </button>

                    <div id="registerMessage"></div>

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                        <strong>ğŸ“‹ ×ª×”×œ×™×š ×”×”×¨×©××”:</strong><br>
                        1. ××œ× ××ª ×”×¤×¨×˜×™× ×•×©×œ×— ×‘×§×©×”<br>
                        2. ×”××¢×¨×›×ª ×ª×©×œ×— ××ª ×”× ×ª×•× ×™× ×œ×× ×”×œ<br>
                        3. ×œ××—×¨ ××™×©×•×¨ ×”×× ×”×œ ×ª×§×‘×œ ××™×™×œ ××™××•×ª<br>
                        4. ×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨ ×‘××™×™×œ ×œ××™××•×ª<br>
                        5. ×œ××—×¨ ×”××™××•×ª ×ª×•×›×œ ×œ×”×ª×—×‘×¨ ×¢× ×ª.×–. ×•×˜×œ×¤×•×Ÿ
                    </div>
                </div>
            </div>

            <!-- ××¡×š ×”××©×¤×—×” -->
            <div id="familyDashboard" class="family-dashboard">
                <button class="logout-btn" onclick="logout()">ğŸšª ×™×¦×™××”</button>

                <div id="userInfo" class="user-info">
                    <!-- ××™×“×¢ ×”××©×ª××© ×™×˜×¢×Ÿ ×›××Ÿ -->
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ × ×ª×•× ×™ ×”××©×¤×—×”...</p>
                </div>

                <div id="familyContent">
                    <!-- ×ª×•×›×Ÿ ×”××©×¤×—×” ×™×˜×¢×Ÿ ×›××Ÿ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×”×•×¡×¤×ª ×™×œ×“ -->
    <div id="addChildModal" class="modal-overlay">
        <div class="modal-content">
            <h2>ğŸ‘¶ ×”×•×¡×¤×ª ×™×œ×“ ×—×“×©</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>×©× ×¤×¨×˜×™ *</label>
                    <input type="text" id="childFirstName" required>
                </div>

                <div class="form-group">
                    <label>××™×Ÿ *</label>
                    <select id="childGender" required>
                        <option value="">×‘×—×¨ ××™×Ÿ</option>
                        <option value="×–×›×¨">×–×›×¨</option>
                        <option value="× ×§×‘×”">× ×§×‘×”</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>×ª××¨×™×š ×œ×™×“×” ×¢×‘×¨×™</label>
                    <input type="text" id="childBirthDate" placeholder="×›×´×’ ××œ×•×œ ×ª×©×¤×´×“">
                </div>

                <div class="form-group">
                    <label>×©× ×”××</label>
                    <input type="text" id="childMotherName">
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>×”×¢×¨×•×ª</label>
                <textarea id="childNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                <strong>âš ï¸ ×©×™× ×œ×‘:</strong> ×”×™×œ×“ ×™×ª×•×•×¡×£ ×œ××¢×¨×›×ª ××š ×™×”×™×” ×‘××¦×‘ "×××ª×™×Ÿ ×œ××™×©×•×¨" ×¢×“ ×©×”×× ×”×œ ×™××©×¨ ××ª ×”×•×¡×¤×ª×•.
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveChild()">
                    ğŸ’¾ ×”×•×¡×£ ×™×œ×“
                </button>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 10px;">
                    âŒ ×‘×™×˜×•×œ
                </button>
            </div>

            <div id="childMessage"></div>
        </div>
    </div>

    <script>
        // ===== ×”×’×“×¨×•×ª ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡ =====
        
        // ğŸ”§ ×”×—×œ×£ ××ª ×”×¢×¨×›×™× ×”××œ×” ×‘×¢×¨×›×™× ×©×œ×š
        const GOOGLE_SHEETS_CONFIG = {
            API_KEY: 'AIzaSyADMdfuBJtqpzH2h5CVr9FxkBn2Eb5oigc',
            SPREADSHEET_ID: '1dLTsow7grSW3S8ggtRsmPrL-Huir_C-Bhw97gul2yog',
            RANGES: {
                MEMBERS: '×›×•×œ×œ×•×ª_×¦×¢×˜×™×œ!A:AD',
                REGISTRATIONS: '× ×ª×•× ×™_×”×—×‘×¨×™×!A:K', // ×¢×“×›×•×Ÿ ×œ×›×œ×•×œ ×¢××•×“×•×ª A-K
                PENDING_CHILDREN: '×™×œ×“×™×_×××ª×™× ×™×!A:J'
            }
        };

        // URL ×©×œ Google Apps Script
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8kJdoUvL7tKNlHOYfpxpRntDQqpY4q27jc8v95N4pSdqM9dJ5n53F_fEN7QIeoQ/exec';

        // ===== ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× =====
        let currentUser = null;
        let allMembers = [];
        let userFamily = null;
        let isConnected = false;

        // ===== ××ª×—×•×œ =====
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('loading');
            initializeApp();
        });

        async function initializeApp() {
            try {
                updateConnectionStatus('loading');
                
                console.log('ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡...');
                await testGoogleSheetsConnection();
                
                console.log('ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×’×•×’×œ ××¤×¡ ×¡×§×¨×™×¤×˜...');
                const scriptWorking = await testGoogleAppsScript();
                
                if (scriptWorking) {
                    console.log('âœ… ×›×œ ×”××¢×¨×›×•×ª ×¢×•×‘×“×•×ª');
                    updateConnectionStatus('connected');
                } else {
                    console.warn('âš ï¸ ×™×© ×‘×¢×™×” ×¢× Google Apps Script');
                    updateConnectionStatus('disconnected');
                    showMessage('warning', '×™×© ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. ×¤×•× ×§×¦×™×•×ª ×”×›×ª×™×‘×” ×¢×œ×•×œ×•×ª ×œ× ×œ×¢×‘×•×“.', 'loginMessage');
                }
                
                isConnected = true;
                                
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘××ª×—×•×œ:', error);
                updateConnectionStatus('disconnected');
                showMessage('error', '××™×Ÿ ×—×™×‘×•×¨ ×œ×©×¨×ª. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.', 'loginMessage');
            }
        }

        // ===== ×¤×•× ×§×¦×™×•×ª ×—×™×‘×•×¨ =====
        async function testGoogleSheetsConnection() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        async function testGoogleAppsScript() {
            try {
                console.log('ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ-Google Apps Script...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                console.log('âœ… ×—×™×‘×•×¨ ×œ-Google Apps Script ×¢×•×‘×“');
                return true;
                
            } catch (error) {
                console.error('âŒ ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ-Google Apps Script:', error);
                return false;
            }
        }

        async function readFromGoogleSheets(range) {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${range}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('×©×’×™××” ×‘×§×¨×™××” ××”×’×™×œ×™×•×Ÿ:', error);
                throw error;
            }
        }

        async function writeToGoogleSheets(range, values) {
            try {
                console.log('×©×•×œ×— × ×ª×•× ×™× ×œ-Google Sheets:', { range, values });
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'write',
                        range: range,
                        values: values
                    })
                });

                console.log('âœ… × ×ª×•× ×™× × ×©×œ×—×• ×œ-Google Sheets');
                return { success: true };

            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×›×ª×™×‘×” ×œ-Google Sheets:', error);
                throw new Error(`×©×’×™××” ×‘×©×œ×™×—×ª ×”× ×ª×•× ×™×: ${error.message}`);
            }
        }

        // ===== ×”×¨×©××” ××¢×•×“×›× ×ª =====
        async function registerUser() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const idNumber = document.getElementById('regId').value.trim();
            const fatherName = document.getElementById('regFatherName').value.trim();
            const motherName = document.getElementById('regMotherName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();

            // ×•×™×“×•× ×©×“×•×ª
            if (!firstName || !lastName || !idNumber || !fatherName || !motherName || !phone || !email) {
                showMessage('error', '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”', 'registerMessage');
                return;
            }

            // ×•×™×“×•× ×ª.×–.
            if (!/^\d{9}$/.test(idNumber)) {
                showMessage('error', '××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª ×—×™×™×‘ ×œ×”×›×™×œ 9 ×¡×¤×¨×•×ª', 'registerMessage');
                return;
            }

            // ×•×™×“×•× ××™×™×œ
            if (!/\S+@\S+\.\S+/.test(email)) {
                showMessage('error', '×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”', 'registerMessage');
                return;
            }

            try {
                showMessage('info', 'ğŸ”„ ×©×•×œ×— ×‘×§×©×ª ×”×¨×©××”...', 'registerMessage');

                // ×‘×“×™×§×” ×× ×”××©×ª××© ×›×‘×¨ ×§×™×™×
                console.log('ğŸ” ×‘×•×“×§ ×× ×”××©×ª××© ×§×™×™×...');
                const existingRegistrations = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);
                
                const userExists = existingRegistrations.some(row => 
                    row[2] === idNumber || row[5] === phone || row[6] === email
                );

                if (userExists) {
                    showMessage('error', '××©×ª××© ×¢× ×”×¤×¨×˜×™× ×”××œ×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'registerMessage');
                    return;
                }

                // ×”×›× ×ª ×”× ×ª×•× ×™× ×œ×©×œ×™×—×” - ××¡×•×“×¨ ×œ×¤×™ ×”×¢××•×“×•×ª ×”× ×›×•× ×•×ª
                const timestamp = new Date().toISOString();
                
                const newRegistration = [
    firstName,                              // ×¢××•×“×” A - ×©× ×¤×¨×˜×™
    lastName,                               // ×¢××•×“×” B - ×©× ××©×¤×—×”  
    email,                                  // ×¢××•×“×” C - ×›×ª×•×‘×ª ××™×™×œ
    idNumber + "\u200B",                         // ×¢××•×“×” D - ××¡' ×ª.×–.
    phone + "\u200B",                            // ×¢××•×“×” E - ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
    `${firstName} ×‘×Ÿ ${motherName}`,        // ×¢××•×“×” F - ×©× ××œ×
    timestamp,                              // ×¢××•×“×” G - ×ª××¨×™×š ×¨×™×©×•×
    '×××ª×™×Ÿ ×œ××™××•×ª',                        // ×¢××•×“×” H - ×¡×˜×˜×•×¡ ××™×©×•×¨
    '×××ª×™×Ÿ ×œ××™××•×ª',                        // ×¢××•×“×” I - ×¡×˜×˜×•×¡ ××™××•×ª
    '',                                     // ×¢××•×“×” J - ××™××•×ª ×× ×”×œ
    '',                                     // ×¢××•×“×” K - ×”×¢×¨×•×ª
    '',                                     // ×¢××•×“×” L - ××¡×¤×¨ ××©×¤×—×”
    fatherName,                             // ×¢××•×“×” M - ×©× ××‘
    motherName                              // ×¢××•×“×” N - ×©× ××
];

                console.log('ğŸ“¤ ×©×•×œ×— × ×ª×•× ×™ ×”×¨×©××”:', newRegistration);

                // ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×’×™×œ×™×•×Ÿ
                await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS, [newRegistration]);
                
                console.log('âœ… × ×ª×•× ×™× × ×©×œ×—×• ×‘×”×¦×œ×—×” ×œ-Google Sheets');

                // ×”×•×“×¢×ª ×”×¦×œ×—×”
                showMessage('success', 
                    `âœ… <strong>×‘×§×©×ª ×”×”×¨×©××” × ×©×œ×—×” ×‘×”×¦×œ×—×”!</strong><br><br>
                    ğŸ“‹ ×”× ×ª×•× ×™× × ×©×œ×—×• ×œ×× ×”×œ ×”××¢×¨×›×ª ×œ×‘×“×™×§×”<br>
                    ğŸ“§ ×œ××—×¨ ××™×©×•×¨ ×”×× ×”×œ ×ª×§×‘×œ ××™×™×œ ××™××•×ª ×œ×›×ª×•×‘×ª: ${email}<br>
                    ğŸ”— ×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨ ×‘××™×™×œ ×›×“×™ ×œ×××ª ××ª ×”×—×©×‘×•×Ÿ<br>
                    âœ… ×œ××—×¨ ×”××™××•×ª ×ª×•×›×œ ×œ×”×ª×—×‘×¨ ×¢× ×ª.×–. ×•×˜×œ×¤×•×Ÿ<br><br>
                    <small>×–××Ÿ ×©×œ×™×—×”: ${new Date().toLocaleString('he-IL')}</small>`, 
                    'registerMessage'
                );

                // × ×™×§×•×™ ×”×˜×•×¤×¡
                document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');

                console.log('âœ… ×ª×”×œ×™×š ×”×”×¨×©××” ×”×•×©×œ× ×‘×”×¦×œ×—×”');

            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×ª×”×œ×™×š ×”×”×¨×©××”:', error);
                showMessage('error', 
                    `âŒ <strong>×©×’×™××” ×‘×ª×”×œ×™×š ×”×”×¨×©××”</strong><br>
                    ${error.message || '×©×’×™××” ×œ× ××–×•×”×”'}<br>
                    ×× × × ×¡×” ×©×•×‘ ××• ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª`, 
                    'registerMessage'
                );
            }
        }

        // ===== ×›× ×™×¡×” ××¢×•×“×›× ×ª =====
        async function loginUser() {
            const idNumber = document.getElementById('loginId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();

            if (!idNumber || !phone) {
                showMessage('error', '×™×© ×œ××œ× ××¡×¤×¨ ×ª.×–. ×•×˜×œ×¤×•×Ÿ', 'loginMessage');
                return;
            }

            if (!/^\d{9}$/.test(idNumber)) {
                showMessage('error', '××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª ×—×™×™×‘ ×œ×”×›×™×œ 9 ×¡×¤×¨×•×ª', 'loginMessage');
                return;
            }

            try {
                showMessage('info', '××ª×—×‘×¨ ×œ××¢×¨×›×ª...', 'loginMessage');

                // ×§×¨×™××ª × ×ª×•× ×™ ×”×”×¨×©××•×ª
               const registrations = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);

// ×”×•×¡×£ ××ª ×–×” ×œ×‘×“×™×§×”:
console.log('×¨×©×™××ª ×›×œ ×”× ×ª×•× ×™×:', registrations);
console.log('××—×¤×© ×ª.×–.:', idNumber);
console.log('××—×¤×© ×˜×œ×¤×•×Ÿ:', phone);

// ×‘×“×™×§×” ××“×•×™×§×ª ×™×•×ª×¨
registrations.slice(1).forEach((row, index) => {
    const rowId = row[3]?.toString().trim();
    const rowPhone = row[4]?.toString().trim();
    
    console.log(`×©×•×¨×” ${index + 1}:`);
    console.log(`  ×ª.×–. ×‘×’×™×œ×™×•×Ÿ: "${rowId}" (××•×¨×š: ${rowId?.length})`);
    console.log(`  ×ª.×–. ×©×”×•×§×œ×“: "${idNumber}" (××•×¨×š: ${idNumber.length})`);
    console.log(`  ×ª×•×× ×ª.×–.: ${rowId === idNumber}`);
    
    console.log(`  ×˜×œ×¤×•×Ÿ ×‘×’×™×œ×™×•×Ÿ: "${rowPhone}" (××•×¨×š: ${rowPhone?.length})`);
    console.log(`  ×˜×œ×¤×•×Ÿ ×©×”×•×§×œ×“: "${phone}" (××•×¨×š: ${phone.length})`);
    console.log(`  ×ª×•×× ×˜×œ×¤×•×Ÿ: ${rowPhone === phone}`);
    console.log('---');
});
// ×—×™×¤×•×© ×”××©×ª××©
// ×—×™×¤×•×© ×”××©×ª××© (××“×œ×’ ×¢×œ ×©×•×¨×ª ×›×•×ª×¨×•×ª)
const userRegistration = registrations.slice(1).find(row => {
    const rowId = row[3]?.toString().replace(/\s/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/[^\d]/g, '');
    const rowPhone = row[4]?.toString().replace(/\s/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/[^\d]/g, '');
    
    // ×”×•×¡×£ ××ª ×–×” ×œ×‘×“×™×§×”:
    console.log('××—×¨×™ × ×™×§×•×™:');
    console.log(`×ª.×–. ×× ×•×§×”: "${rowId}" (××•×¨×š: ${rowId.length})`);
    console.log(`×˜×œ×¤×•×Ÿ ×× ×•×§×”: "${rowPhone}" (××•×¨×š: ${rowPhone.length})`);
    console.log(`×”×ª×××”: ${rowId === idNumber && rowPhone === phone}`);
    
    return rowId === idNumber && rowPhone === phone;
});
console.log('×ª×•×¦××ª ×”×—×™×¤×•×©:', userRegistration);

                if (!userRegistration) {
                    // ×”××©×ª××© ×œ× × ××¦× ×‘×›×œ×œ
                    showMessage('error', 
                        `âŒ <strong>×œ× × ××¦× ××©×ª××© ×¢× ×”×¤×¨×˜×™× ×”××œ×”</strong><br><br>
                        ×™×ª×›×Ÿ ×©×¢×“×™×™×Ÿ ×œ× × ×¨×©××ª ×œ××¢×¨×›×ª:`, 
                        'loginMessage'
                    );
                    
                    // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”×¤× ×™×” ×œ×”×¨×©××”
                    setTimeout(() => {
                        const loginMessageDiv = document.getElementById('loginMessage');
                        const registerBtn = document.createElement('button');
                        registerBtn.className = 'redirect-to-register';
                        registerBtn.textContent = 'ğŸ“ ×œ×—×¥ ×›××Ÿ ×œ×”×¨×©××”';
                        registerBtn.onclick = () => {
                            showRegisterForm();
                            loginMessageDiv.innerHTML = '';
                        };
                        loginMessageDiv.appendChild(registerBtn);
                    }, 100);
                    
                    return;
                }

                // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×”××™××•×ª
                const verificationStatus = userRegistration[9]; // ×¢××•×“×” J
const approvalStatus = userRegistration[7];     // ×¢××•×“×” H - ×”×•×¡×£ ××ª ×–×”

if (verificationStatus !== '××•××ª') {
    let statusMessage = '';
    
    if (approvalStatus === '×××ª×™×Ÿ ×œ××™××•×ª') {  // ×©× ×” ×œ×‘×“×•×§ ×¢××•×“×” H
        statusMessage = `â³ <strong>×”×—×©×‘×•×Ÿ ×©×œ×š ×¢×“×™×™×Ÿ ×œ× ××•××ª</strong><br><br>
        ğŸ“‹ ×”×¨×©××ª×š × ×§×œ×˜×” ×‘××¢×¨×›×ª ××š ×¢×“×™×™×Ÿ ×××ª×™× ×” ×œ××™×©×•×¨ ×”×× ×”×œ<br>
        ğŸ“§ ×œ××—×¨ ××™×©×•×¨ ×”×× ×”×œ ×ª×§×‘×œ ××™×™×œ ××™××•×ª<br>
        ğŸ”— ×ª×¦×˜×¨×š ×œ×œ×—×•×¥ ×¢×œ ×”×§×™×©×•×¨ ×‘××™×™×œ ×›×“×™ ×œ×××ª ××ª ×”×—×©×‘×•×Ÿ<br><br>
        ×× ×—×œ×£ ×–××Ÿ ×¨×‘ ×•×œ× ×§×™×‘×œ×ª ××™×™×œ, ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.`;
    } else {
        statusMessage = `âŒ <strong>×”×—×©×‘×•×Ÿ ×©×œ×š ×œ× ××•××ª</strong><br><br>
        ×¡×˜×˜×•×¡ × ×•×›×—×™: ${verificationStatus}<br>
        ×™×© ×œ×××ª ××ª ×”×—×©×‘×•×Ÿ ×œ×¤× ×™ ×”×›× ×™×¡×” ×œ××¢×¨×›×ª.<br><br>
        ×× ×™×© ×‘×¢×™×”, ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.`;
    }
                    
                    showMessage('warning', statusMessage, 'loginMessage');
                    
                    // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”×¤× ×™×” ×œ×”×¨×©××”
                    setTimeout(() => {
                        const loginMessageDiv = document.getElementById('loginMessage');
                        const registerBtn = document.createElement('button');
                        registerBtn.className = 'redirect-to-register';
                        registerBtn.textContent = 'ğŸ“ ××•×œ×™ ×ª×¨×¦×” ×œ×”×™×¨×©× ×©×•×‘?';
                        registerBtn.onclick = () => {
                            showRegisterForm();
                            loginMessageDiv.innerHTML = '';
                        };
                        loginMessageDiv.appendChild(registerBtn);
                    }, 100);
                    
                    return;
                }

                // ×”××©×ª××© ×××•××ª - ××ª×—×‘×¨
                currentUser = {
    firstName: userRegistration[0],
    lastName: userRegistration[1], 
    idNumber: userRegistration[2],
    fatherName: userRegistration[3],
    motherName: userRegistration[4],
    phone: userRegistration[5],
    email: userRegistration[6],
    familyNumber: userRegistration[10] // ×¢××•×“×” K - ××¡×¤×¨ ××©×¤×—×”
};

// ××¢×‘×¨ ×œ×ª×¦×•×’×ª ×”××©×¤×—×”
showUserFamily(userRegistration[6]);

            } catch (error) {
                console.error('×©×’×™××” ×‘×›× ×™×¡×”:', error);
                showMessage('error', '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'loginMessage');
            }
        }

        // ===== ×××©×§ ×”××©×¤×—×” =====
        async function loadUserDashboard() {
            try {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('familyDashboard').style.display = 'block';
                document.getElementById('loading').style.display = 'block';

                // ×¢×“×›×•×Ÿ ××™×“×¢ ×”××©×ª××©
                document.getElementById('userInfo').innerHTML = `
                    <h2>×©×œ×•× ${currentUser.firstName} ${currentUser.lastName}</h2>
                    <p>ğŸ“§ ${currentUser.email} | ğŸ“± ${currentUser.phone}</p>
                    <p>×‘×Ÿ ${currentUser.motherName} ×•××‘×™ ${currentUser.fatherName}</p>
                    ${currentUser.familyNumber ? `<p><strong>××¡×¤×¨ ××©×¤×—×”: ${currentUser.familyNumber}</strong></p>` : ''}
                `;

                // ×× ×™×© ××¡×¤×¨ ××©×¤×—×” - ×”×¦×’ ××ª ×”××©×¤×—×”
                if (currentUser.familyNumber) {
                    await loadMembersData();
                    await findUserFamily();
                    displayUserFamily();
                } else {
                    // ××™×Ÿ ××¡×¤×¨ ××©×¤×—×” - ×”×•×“×¢×” ×œ××©×ª××©
                    document.getElementById('familyContent').innerHTML = `
                        <div class="message warning">
                            <h3>âš ï¸ ××¡×¤×¨ ××©×¤×—×” ×œ× ×”×•×’×“×¨</h3>
                            <p>×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨ ××¡×¤×¨ ××©×¤×—×” ×¢×‘×•×¨ ×”×—×©×‘×•×Ÿ ×©×œ×š.</p>
                            <p>×× × ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª ×œ×”×©×œ××ª ×”×¤×¨×˜×™×.</p>
                        </div>
                    `;
                }

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×××©×§:', error);
                showMessage('error', '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××©×¤×—×”', 'familyContent');
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadMembersData() {
            const membersData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
            
            if (membersData.length > 1) {
                const headers = membersData[0];
                allMembers = membersData.slice(1).map(row => {
                    const member = {};
                    headers.forEach((header, index) => {
                        member[header] = row[index] || '';
                    });
                    return member;
                });
            }
        }

        async function findUserFamily() {
            if (currentUser.familyNumber) {
                userFamily = await buildFamilyStructure(currentUser.familyNumber);
            }
        }

        async function buildFamilyStructure(familyNumber) {
            const father = allMembers.find(m => 
                parseInt(m.××©×¤_×¢×¦××™) === parseInt(familyNumber) && m.×¨××©_××©×¤×—×” === 'TRUE'
            );

            const mother = allMembers.find(m => 
                parseInt(m.××¡×¤×¨_×”×–×•×’) === parseInt(father?.××¡×¤×¨_××™×©×™)
            );

            const children = allMembers.filter(m => 
                parseInt(m.××©×¤_×”×•×¨×™×) === parseInt(familyNumber)
            ).sort((a, b) => {
                const aNum = parseInt(a.××¡×¤×¨_×‘×Ÿ) || 999;
                const bNum = parseInt(b.××¡×¤×¨_×‘×Ÿ) || 999;
                return aNum - bNum;
            });

            return {
                familyNumber: familyNumber,
                father: father,
                mother: mother,
                children: children,
                lastName: father?.×©×_××©×¤×—×” || mother?.×©×_××©×¤×—×”,
                marriageDate: father?.×ª××¨×™×š_× ×©×•××™×Ÿ
            };
        }

        
        function createChildCard(child) {
            const benBat = child.××™×Ÿ === '×–×›×¨' ? '×‘×Ÿ' : '×‘×ª';
            const motherName = child.×©×_×× || userFamily.mother?.×©×_×¤×¨×˜×™ || '';
            const fullChildName = motherName ? `${child.×©×_×¤×¨×˜×™} ${benBat} ${motherName}` : child.×©×_×¤×¨×˜×™;
            
            const isApproved = child.×××•×©×¨ !== '×××ª×™×Ÿ ×œ××™×©×•×¨';
            
            return `
                <div class="child-item ${isApproved ? 'approved' : 'pending'}">
                    <div class="child-info">
                        <div class="child-name">
                            ${child.××¡×¤×¨_×‘×Ÿ ? `${child.××¡×¤×¨_×‘×Ÿ}. ` : ''}${fullChildName}
                        </div>
                        <div class="child-details">
                            ${child.××™×Ÿ} â€¢ ××¡×¤×¨ ${child.××¡×¤×¨_××™×©×™}
                            ${child.×ª××¨×™×š_×œ×™×“×” ? ` â€¢ ${child.×ª××¨×™×š_×œ×™×“×”}` : ''}
                            ${child.×”×¢×¨×” ? ` â€¢ ${child.×”×¢×¨×”}` : ''}
                        </div>
                    </div>
                    <div class="child-status ${isApproved ? 'status-approved' : 'status-pending'}">
                        ${isApproved ? 'âœ… ×××•×©×¨' : 'â³ ×××ª×™×Ÿ ×œ××™×©×•×¨'}
                    </div>
                </div>
            `;
        }

        // ===== ×”×•×¡×¤×ª ×™×œ×“ =====
        function openAddChildModal() {
            document.getElementById('addChildModal').style.display = 'flex';
            
            const motherName = userFamily.mother?.×©×_×¤×¨×˜×™ || '';
            document.getElementById('childMotherName').value = motherName;
        }

        async function saveChild() {
            const firstName = document.getElementById('childFirstName').value.trim();
            const gender = document.getElementById('childGender').value;
            const birthDate = document.getElementById('childBirthDate').value.trim();
            const motherName = document.getElementById('childMotherName').value.trim();
            const notes = document.getElementById('childNotes').value.trim();

            if (!firstName || !gender) {
                showMessage('error', '×™×© ×œ××œ× ×©× ×¤×¨×˜×™ ×•××™×Ÿ', 'childMessage');
                return;
            }

            try {
                showMessage('info', '×©×•××¨ ×™×œ×“...', 'childMessage');

                const maxChildNumber = userFamily.children.reduce((max, child) => {
                    const num = parseInt(child.××¡×¤×¨_×‘×Ÿ) || 0;
                    return num > max ? num : max;
                }, 0);

                const nextChildNumber = maxChildNumber + 1;

                const childData = [
                    firstName,
                    userFamily.lastName,
                    gender,
                    birthDate,
                    notes,
                    motherName,
                    userFamily.familyNumber,
                    nextChildNumber,
                    new Date().toISOString(),
                    '×××ª×™×Ÿ ×œ××™×©×•×¨'
                ];

                await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.PENDING_CHILDREN, [childData]);

                showMessage('success', 
                    `×”×™×œ×“ ${firstName} × ×•×¡×£ ×‘×”×¦×œ×—×”!<br>×”×•× ×××ª×™×Ÿ ×›×¢×ª ×œ××™×©×•×¨ ×”×× ×”×œ.`, 
                    'childMessage'
                );

                document.getElementById('childFirstName').value = '';
                document.getElementById('childGender').value = '';
                document.getElementById('childBirthDate').value = '';
                document.getElementById('childNotes').value = '';

                setTimeout(async () => {
                    closeModal();
                    showUserFamily(currentUser.email);
                }, 2000);

            } catch (error) {
                console.error('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×™×œ×“:', error);
                showMessage('error', '×©×’×™××” ×‘×©××™×¨×ª ×”×™×œ×“. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'childMessage');
            }
        }

        // ===== ×××©×§ ××©×ª××© =====
        function showLoginForm() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginMessage').innerHTML = '';
        }

        function showRegisterForm() {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registerMessage').innerHTML = '';
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'âœ… ××—×•×‘×¨';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'âŒ ×œ× ××—×•×‘×¨';
                    break;
                case 'loading':
                    statusElement.textContent = 'ğŸ”„ ××ª×—×‘×¨...';
                    break;
            }
        }

        function showMessage(type, message, elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                if (element.innerHTML.includes(message)) {
                    element.innerHTML = '';
                }
            }, 15000);
        }

        function closeModal() {
            document.getElementById('addChildModal').style.display = 'none';
            document.getElementById('childMessage').innerHTML = '';
        }

        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                localStorage.removeItem('familyUser');
                currentUser = null;
                userFamily = null;
                
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('familyDashboard').style.display = 'none';
                
                document.querySelectorAll('#loginForm input').forEach(input => input.value = '');
                document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');
                
                showLoginForm();
            }
        }

        // ===== ×”××–× ×” ×œ××™×¨×•×¢×™× =====
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ×•×™×“×•× ××¡×¤×¨×™× ×‘×œ×‘×“ ×‘×ª.×–.
        document.addEventListener('DOMContentLoaded', function() {
            const idInputs = ['regId', 'loginId'];
            idInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function(e) {
                        this.value = this.value.replace(/\D/g, '');
                    });
                }
            });
        });
        // ===== ×”×¦×’×ª ××©×¤×—×ª ×”××©×ª××© ××—×¨×™ ×”×ª×—×‘×¨×•×ª ××•×¦×œ×—×ª =====
function showUserFamily(userEmail) {
    showMessage('info', 'ğŸ”„ ×˜×•×¢×Ÿ ××ª ×”××©×¤×—×” ×©×œ×š...', 'loginMessage');
    
    // ×‘××§×•× google.script.run, × ×©×ª××© ×‘×¤×•× ×§×¦×™×•×ª ×”×§×™×™××•×ª ×©×œ×š
    loadUserFamilyFromSheets(userEmail);
}

async function loadUserFamilyFromSheets(userEmail) {
    try {
        // ×§×‘×œ×ª ××¡×¤×¨ ×”××©×¤×—×” ×©×œ ×”××©×ª××©
        const familyNumber = currentUser.familyNumber; // ×›×‘×¨ ×™×© ×œ× ×• ×‘××©×ª× ×” currentUser
        
        console.log('××¡×¤×¨ ××©×¤×—×” ×©× ××¦×:', familyNumber); // ×”×•×¡×£ ××ª ×–×”
        
        if (!familyNumber) {
            showMessage('warning', '×œ× × ××¦× ××¡×¤×¨ ××©×¤×—×” ×¢×‘×•×¨×š. ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.', 'loginMessage');
            return;
        }
        
        console.log('×§×•×¨× × ×ª×•× ×™× ××’×œ×™×•×Ÿ ×›×•×œ×œ×•×ª_×¦×¢×˜×™×œ...'); // ×”×•×¡×£ ××ª ×–×”
        
        // ×§×¨×™××ª × ×ª×•× ×™ ××©×¤×—×” ××’×œ×™×•×Ÿ ×›×•×œ×œ×•×ª_×¦×¢×˜×™×œ
        const familyData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
        
        console.log('× ×ª×•× ×™× ×©×”×ª×§×‘×œ×•:', familyData?.length, '×©×•×¨×•×ª'); // ×”×•×¡×£ ××ª ×–×”
        
        const processedFamilyData = organizeFamilyDataFromSheets(familyData, familyNumber);
        
        console.log('× ×ª×•× ×™ ××©×¤×—×” ××¢×•×‘×“×™×:', processedFamilyData); // ×”×•×¡×£ ××ª ×–×”
        
        if (processedFamilyData) {
            displayUserFamily(processedFamilyData);
        } else {
            showMessage('error', '×œ× × ××¦××• × ×ª×•× ×™ ××©×¤×—×” ××¡×¤×¨: ' + familyNumber, 'loginMessage');
        }
        
    } catch (error) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×¤×—×”:', error);
        showMessage('error', '×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×¤×—×”: ' + error.toString(), 'loginMessage');
    }
}

function organizeFamilyDataFromSheets(data, familyNumber) {
    if (!data || data.length === 0) return null;
    
    const familyMembers = [];
    
    console.log('××—×¤×© ××©×¤×—×” ××¡×¤×¨:', familyNumber, '×˜×™×¤×•×¡:', typeof familyNumber);
    
    // ×—×™×¤×•×© ×›×œ ×—×‘×¨×™ ×”××©×¤×—×” (××“×œ×’ ×¢×œ ×©×•×¨×ª ×›×•×ª×¨×•×ª)
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const ownFamily = row[24]; // ×¢××•×“×” Y - ××©×¤_×¢×¦××™
        const parentsFamily = row[25]; // ×¢××•×“×” Z - ××©×¤_×”×•×¨×™×
        
        if (ownFamily == familyNumber || parentsFamily == familyNumber) {
            console.log('× ××¦× ×—×‘×¨ ××©×¤×—×”:', {
                ×©×: row[1],
                ××™×Ÿ: row[3],
                ××©×¤_×¢×¦××™: ownFamily,
                ××©×¤_×”×•×¨×™×: parentsFamily,
                ×¨××©_××©×¤×—×”: row[22] // ×¢××•×“×” W
            });
            
            familyMembers.push({
   
    ××¡×¤×¨_××™×©×™: row[0],             // A  
    ×©×_×¤×¨×˜×™: row[1],               // B  
    ×©×_××: row[2],                 // C  
    ×©×_××©×¤×—×”: row[3],             // D  
    ××™×Ÿ: row[4],                   // E  
    ×ª××¨×™×š_×œ×™×“×”: row[5],           // F  
    ×ª××¨×™×š_× ×©×•××™×Ÿ: row[6],         // G  
    ×¤×¢×™×œ: row[7],                  // H  
    × ×©×•×™_×¨×•×•×§: row[8],            // I  
    ×”×¢×¨×”: row[9],                  // J  
    ××¡×¤×¨_×”×–×•×’: row[10],           // K  
    ××¡×¤×¨_××‘: row[11],             // L  
    ××¡×¤×¨_××: row[12],             // M  
    ×ª××¨×™×š_×›× ×™×¡×”: row[13],         // N  
    ×©×¢×ª_×›× ×™×¡×”: row[14],           // O  
    ×”×¢×¨×”_×¤×¢×™×œ×”: row[15],          // P  
    ××’×•×¨×™×: row[16],              // Q  
    ×œ×_×× ×©: row[17],               // R  
    ××¡×¤×¨_×‘×Ÿ: row[18],             // S  
    ×–×•×’: row[19],                  // T  
    ×‘× ×: row[20],                  // U  
    ××™×•×Ÿ: row[21],                 // V  
    ×¨××©_××©×¤×—×”: row[22],           // W  
    ×‘×Ÿ_×‘×ª: row[23],               // X  
    ××©×¤_×¢×¦××™: row[24],            // Y  
    ××©×¤_×”×•×¨×™×: row[25],           // Z  
    ×¤×¨×©×”_×‘×©××—×ª_×¢×•×œ×: row[26],     // AA  
    ×”×•×’×”_×‘×ª×©×¡×’: row[27],           // AB  
    ×¢×™×¨_××’×•×¨×™×: row[28],          // AC  
    ×”×•×’×”_×ª×©×¢×“: row[29]            // AD
});
                  }
    }
    
    console.log('×¡×”"×› ×—×‘×¨×™ ××©×¤×—×” × ××¦××•:', familyMembers.length);
    
    // ××¨×’×•×Ÿ × ×ª×•× ×™ ×”××©×¤×—×”
    const parents = familyMembers.filter(m => m.××©×¤_×¢×¦××™ == familyNumber);
    console.log('×”×•×¨×™× × ××¦××•:', parents.length, parents);
    
    const father = parents.find(p => p.××™×Ÿ === '×–×›×¨');
    const mother = parents.find(p => p.××™×Ÿ === '× ×§×‘×”');
    const children = familyMembers.filter(m => m.××©×¤_×”×•×¨×™× == familyNumber);
    
    console.log('××‘:', father?.×©×_×¤×¨×˜×™);
    console.log('××:', mother?.×©×_×¤×¨×˜×™);
    console.log('×™×œ×“×™×:', children.length);
    
    return {
        familyNumber: familyNumber,
        lastName: father?.×©×_××©×¤×—×” || mother?.×©×_××©×¤×—×” || '',
        city: father?.×¢×™×¨_××’×•×¨×™× || mother?.×¢×™×¨_××’×•×¨×™× || '',
        father: father,
        mother: mother,
        children: children
    };
}
// ===== ×˜×¢×™× ×ª × ×ª×•× ×™ ×”××©×¤×—×” =====
function loadUserFamilyData(familyNumber) {
    google.script.run
        .withSuccessHandler(function(familyData) {
            if (familyData) {
                displayUserFamily(familyData);
            } else {
                showMessage('error', '×œ× × ××¦××• × ×ª×•× ×™ ××©×¤×—×” ××¡×¤×¨: ' + familyNumber, 'loginMessage');
            }
        })
        .withFailureHandler(function(error) {
            showMessage('error', '×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×¤×—×”: ' + error.toString(), 'loginMessage');
        })
        .getUserFamilyData(familyNumber);
}

// ===== ×”×¦×’×ª ×”××©×¤×—×” =====
function displayUserFamily(familyData, isChildFamily = false) {
    console.log('displayUserFamily × ×§×¨××” ×¢×:', familyData);
    console.log('×”×× ×–×• ××©×¤×—×ª ×™×œ×“?', isChildFamily);
    
    // ××—×™×§×ª ×ª×¦×•×’×ª ××©×¤×—×” ×§×•×“××ª ×× ×§×™×™××ª
    const existingContainer = document.getElementById('familyViewContainer');
    if (existingContainer) {
        existingContainer.remove();
    }
    
    // ×”×¡×ª×¨×ª ×˜×•×¤×¡ ×”×”×ª×—×‘×¨×•×ª
    const forms = document.querySelectorAll('[class*="container"], [id*="login"], [id*="form"]');
    forms.forEach(form => {
        if (form.style.display !== 'none') {
            form.style.display = 'none';
        }
    });
    
    // ×™×¦×™×¨×ª ×ª×¦×•×’×ª ×”××©×¤×—×”
    const familyContainer = document.createElement('div');
    familyContainer.id = 'familyViewContainer';
    familyContainer.innerHTML = createFamilyViewHTML(familyData, isChildFamily);
    
    document.body.appendChild(familyContainer);
    
    console.log('×”××©×¤×—×” ×”×•×¦×’×” ×‘×”×¦×œ×—×”');
}

// ===== ×™×¦×™×¨×ª HTML ×œ×ª×¦×•×’×ª ×”××©×¤×—×” =====
function createFamilyViewHTML(family) {
    // ×”×¤×¨×“×ª ×™×œ×“×™× ×œ×¨×•×•×§×™× ×•× ×©×•××™×
    const singleChildren = family.children ? family.children.filter(child => 
        !child['× ×©×•×™/×¨×•×•×§'] || child['× ×©×•×™/×¨×•×•×§'].includes('×¨×•×•×§')
    ).sort((a, b) => {
        const aNum = parseInt(a.××¡×¤×¨_×‘×Ÿ) || 999;
        const bNum = parseInt(b.××¡×¤×¨_×‘×Ÿ) || 999;
        return aNum - bNum;
    }) : [];

    const marriedChildren = family.children ? family.children.filter(child => 
        child['× ×©×•×™/×¨×•×•×§'] && !child['× ×©×•×™/×¨×•×•×§'].includes('×¨×•×•×§')
    ).sort((a, b) => {
        const aNum = parseInt(a.××¡×¤×¨_×‘×Ÿ) || 999;
        const bNum = parseInt(b.××¡×¤×¨_×‘×Ÿ) || 999;
        return aNum - bNum;
    }) : [];

    return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;" dir="rtl">
            
            <!-- ×©×œ×•× ××©×ª××© -->
            <div style="position: fixed; top: 20px; right: 20px; background: rgba(76, 175, 80, 0.9); color: white; padding: 12px 20px; border-radius: 25px; font-weight: bold; z-index: 1000;">
                ğŸ‘‹ ×©×œ×•× ${currentUserName}
            </div>

            <!-- ×§×•× ×˜×™×™× ×¨ ×¨××©×™ -->
            <div style="max-width: 1200px; margin: 80px auto 0; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden;">
                
                <!-- ×›×•×ª×¨×ª ×”××©×¤×—×” -->
                <div style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 30px; text-align: center; position: relative;">
    
    <!-- ×œ×—×¦× ×™× ××¨×—×¤×™× ×¢×œ ×”×©×˜×— ×”×™×¨×•×§ -->
    <div style="position: absolute; top: 15px; left: 15px; display: flex; gap: 10px; z-index: 100;">
        <button onclick="logoutUser()" style="background: #f44336; color: white; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px;">
            ğŸšª ×™×¦×™××”
        </button>
        
        <button id="returnButton" onclick="returnToParentFamily()" style="background: #2196F3; color: white; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px; transition: all 0.3s ease;"
                onmouseover="this.style.background='#1976D2'; this.style.transform='scale(1.05)';"
                onmouseout="this.style.background='#2196F3'; this.style.transform='scale(1)';">
            â¬…ï¸ ×—×–×•×¨ ×œ××©×¤×—×” ×”××•×¨×—×‘×ª
        </button>
    </div>
                    <h1 style="margin: 0; font-size: 2.5em;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ××©×¤×—×ª ${family.lastName || '×œ× ××•×’×“×¨'}</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.2em;">××©×¤×—×” ××¡×¤×¨ ${family.familyNumber}</p>
                    ${family.city ? `<p style="margin: 5px 0 0 0;">ğŸ™ï¸ ${family.city}</p>` : ''}
                </div>

                <!-- ×ª×•×›×Ÿ ×”××©×¤×—×” -->
                <div style="padding: 30px;">
                    
                    <!-- ×”×”×•×¨×™× -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <!-- ×”××‘ -->
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 25px; border-radius: 12px; border: 2px solid #2196F3;">
                            <h3 style="margin-top: 0; color: #1565c0; text-align: center;">ğŸ‘¨ ×”×‘×¢×œ</h3>
                            ${family.father ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">${family.father.×©×_×¤×¨×˜×™} ${family.father.×©×_××©×¤×—×”}</div>
                                    <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                        <div>ğŸ†” ××¡×¤×¨ ××™×©×™: ${family.father.××¡×¤×¨_××™×©×™}</div>
                                        ${family.father.×ª××¨×™×š_×œ×™×“×” ? `<div>ğŸ‚ ×ª××¨×™×š ×œ×™×“×”: ${family.father.×ª××¨×™×š_×œ×™×“×”}</div>` : ''}
                                        ${family.father.×©×_×× ? `<div>ğŸ‘© ×©× ×”××: ${family.father.×©×_××}</div>` : ''}
                                        ${family.father.×¢×™×¨_××’×•×¨×™× ? `<div>ğŸ  ×¢×™×¨ ××’×•×¨×™×: ${family.father.×¢×™×¨_××’×•×¨×™×}</div>` : ''}
                                    </div>
                                </div>
                            ` : '<div style="text-align: center; color: #999;">××™×Ÿ × ×ª×•× ×™ ×‘×¢×œ</div>'}
                        </div>

                        <!-- ×”××™×©×” -->
                        <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 25px; border-radius: 12px; border: 2px solid #e91e63;">
                            <h3 style="margin-top: 0; color: #c2185b; text-align: center;">ğŸ‘© ×”××™×©×”</h3>
                            ${family.mother ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">${family.mother.×©×_×¤×¨×˜×™} ${family.mother.×©×_××©×¤×—×”}</div>
                                    <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                        <div>ğŸ†” ××¡×¤×¨ ××™×©×™: ${family.mother.××¡×¤×¨_××™×©×™}</div>
                                        ${family.mother.×ª××¨×™×š_×œ×™×“×” ? `<div>ğŸ‚ ×ª××¨×™×š ×œ×™×“×”: ${family.mother.×ª××¨×™×š_×œ×™×“×”}</div>` : ''}
                                        ${family.mother.×©×_×× ? `<div>ğŸ‘© ×©× ×”××: ${family.mother.×©×_××}</div>` : ''}
                                        ${family.mother.×ª××¨×™×š_× ×©×•××™×Ÿ ? `<div>ğŸ’’ ×ª××¨×™×š ×—×ª×•× ×”: ${family.mother.×ª××¨×™×š_× ×©×•××™×Ÿ}</div>` : ''}
                                    </div>
                                </div>
                            ` : '<div style="text-align: center; color: #999;">××™×Ÿ × ×ª×•× ×™ ××™×©×”</div>'}
                        </div>
                    </div>

                    <!-- ×™×œ×“×™× ×¨×•×•×§×™× -->
                    ${singleChildren.length > 0 ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #ff6f00; margin-bottom: 15px; text-align: center; font-size: 1.5em;">
                                ğŸ‘¶ ×™×œ×“×™× ×¨×•×•×§×™× (${singleChildren.length}) - ×œ×¤×™ ×¡×“×¨ ×”×œ×™×“×”
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                ${singleChildren.map(child => createChildCard(child, 'single')).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- ×™×œ×“×™× × ×©×•××™× -->
                    ${marriedChildren.length > 0 ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #2e7d32; margin-bottom: 15px; text-align: center; font-size: 1.5em;">
                                ğŸ’’ ×™×œ×“×™× × ×©×•××™× (${marriedChildren.length}) - ×œ×¤×™ ×¡×“×¨ ×”×œ×™×“×”
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                ${marriedChildren.map(child => createChildCard(child, 'married')).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- ××™×Ÿ ×™×œ×“×™× -->
                    ${singleChildren.length === 0 && marriedChildren.length === 0 ? `
                        <div style="text-align: center; color: #666; padding: 40px; font-style: italic;">
                            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ‘¶</div>
                            <div>××™×Ÿ ×™×œ×“×™× ×¨×©×•××™× ×‘××©×¤×—×” ×–×•</div>
                        </div>
                    ` : ''}

                </div>
            </div>
        </div>
    `;
}

// ===== ×™×¦×™×¨×ª ×›×¨×˜×™×¡ ×™×œ×“ =====
function createChildCard(child, type) {
    const childNumber = child.××¡×¤×¨_×‘×Ÿ || '';
    const benBat = child.××™×Ÿ === '×–×›×¨' ? '×‘×Ÿ' : '×‘×ª';
    const motherName = child.×©×_×× || '';
    const fullChildName = motherName ? `${child.×©×_×¤×¨×˜×™} ${benBat} ${motherName}` : child.×©×_×¤×¨×˜×™;
    
    // ×”×¤×¨×“×” ×‘×™×Ÿ ×¨×•×•×§×™× ×•× ×©×•××™× ×œ×¤×™ ×”× ×ª×•× ×™×
    const isMarried = child.× ×©×•×™_×¨×•×•×§ && !child.× ×©×•×™_×¨×•×•×§.includes('×¨×•×•×§') && child.××©×¤_×¢×¦××™ && child.××©×¤_×¢×¦××™ !== '0';
    const cardType = isMarried ? 'married' : 'single';
    
    // ×§×‘×™×¢×ª ×¦×‘×¢ ×¨×§×¢
    const bgColor = cardType === 'married' ? 
        'linear-gradient(135deg, #f0fff0, #c8e6c8)' : 
        'linear-gradient(135deg, #fff3e0, #ffe0b2)';
    
    const borderColor = cardType === 'married' ? '#4caf50' : '#ff9800';
    
    return `
        <div style="
            background: ${bgColor}; 
            border: 2px solid ${borderColor}; 
            border-radius: 12px; 
            padding: 20px; 
            transition: all 0.3s ease;
            cursor: pointer;
        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 8px;">
                        ${childNumber ? `${childNumber}. ` : ''}${fullChildName}
                        ${cardType === 'married' ? ' ğŸ’’' : ' ğŸ‘¶'}
                    </div>
                    <div style="font-size: 0.9em; color: #666; line-height: 1.4;">
                        <div>${child.××™×Ÿ} - ××¡×¤×¨ ${child.××¡×¤×¨_××™×©×™}</div>
                        ${child.×ª××¨×™×š_×œ×™×“×” ? `<div>ğŸ‚ ${child.×ª××¨×™×š_×œ×™×“×”}</div>` : ''}
                        ${cardType === 'married' && child.× ×©×•×™_×¨×•×•×§ ? `<div>ğŸ’’ ${child.× ×©×•×™_×¨×•×•×§}</div>` : ''}
                        ${cardType === 'married' && child.××©×¤_×¢×¦××™ ? `<div>ğŸ  ××©×¤×—×” ××¡×¤×¨ ${child.××©×¤_×¢×¦××™}</div>` : ''}
                        ${child.×”×¢×¨×” ? `<div>ğŸ“ ${child.×”×¢×¨×”}</div>` : ''}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    ${cardType === 'married' && child.××©×¤_×¢×¦××™ && child.××©×¤_×¢×¦××™ !== '0' ? `
                        <button onclick="viewChildFamily('${child.××¡×¤×¨_××™×©×™}', '${child.×©×_×¤×¨×˜×™}', '${child.××©×¤_×¢×¦××™}')" 
                                style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#1976D2'; this.style.transform='scale(1.05)';"
                                onmouseout="this.style.background='#2196F3'; this.style.transform='scale(1)';">
                            ğŸ  ×¦×¤×” ×‘××©×¤×—×”
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}
let parentFamilyStack = [];

// ×¦×¤×™×™×” ×‘××©×¤×—×ª ×™×œ×“ × ×©×•×™
function viewChildFamily(childPersonalNumber, childName, childFamilyNumber) {
    console.log('viewChildFamily × ×§×¨××”:', {childPersonalNumber, childName, childFamilyNumber});
    
    // ×× ×–×” ×”×¤×¢× ×”×¨××©×•× ×” ×©× ×›× ×¡×™× ×œ××©×¤×—×ª ×™×œ×“, ×©××•×¨ ××ª ×”××©×¤×—×” ×”××§×•×¨×™×ª
    if (parentFamilyStack.length === 0) {
        parentFamilyStack.push(currentUser.familyNumber);
        console.log('×©××™×¨×ª ××©×¤×—×” ××§×•×¨×™×ª ×‘××—×¡× ×™×ª:', currentUser.familyNumber);
    }
    
    // ×”×¦×’ ××ª ×œ×—×¦×Ÿ ×”×—×–×¨×”
    const returnButton = document.getElementById('returnButton');
    if (returnButton) {
        returnButton.style.display = 'block';
    }
    
    console.log('×˜×•×¢×Ÿ ××©×¤×—×ª ×™×œ×“:', childFamilyNumber);
    
    // ×˜×¢×Ÿ ××ª ××©×¤×—×ª ×”×™×œ×“
    loadUserFamilyFromSheets(null, childFamilyNumber);
}

// ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×™×ª ×”×˜×¢×™× ×” ×œ×§×‘×œ ××¡×¤×¨ ××©×¤×—×”
async function loadUserFamilyFromSheets(userEmail, specificFamilyNumber = null) {
    try {
        // ×§×‘×œ×ª ××¡×¤×¨ ×”××©×¤×—×”
        const familyNumber = specificFamilyNumber || currentUser.familyNumber;
        
        console.log('××¡×¤×¨ ××©×¤×—×” ×©× ××¦×:', familyNumber);
        
        if (!familyNumber) {
            showMessage('warning', '×œ× × ××¦× ××¡×¤×¨ ××©×¤×—×” ×¢×‘×•×¨×š. ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª.', 'loginMessage');
            return;
        }
        
        console.log('×§×•×¨× × ×ª×•× ×™× ××’×œ×™×•×Ÿ ×›×•×œ×œ×•×ª_×¦×¢×˜×™×œ...');
        
        const familyData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
        
        console.log('× ×ª×•× ×™× ×©×”×ª×§×‘×œ×•:', familyData?.length, '×©×•×¨×•×ª');
        
        const processedFamilyData = organizeFamilyDataFromSheets(familyData, familyNumber);
        
        console.log('× ×ª×•× ×™ ××©×¤×—×” ××¢×•×‘×“×™×:', processedFamilyData);
        
        if (processedFamilyData) {
            displayUserFamily(processedFamilyData, specificFamilyNumber !== null);
        } else {
            showMessage('error', '×œ× × ××¦××• × ×ª×•× ×™ ××©×¤×—×” ××¡×¤×¨: ' + familyNumber, 'loginMessage');
        }
        
    } catch (error) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×¤×—×”:', error);
        showMessage('error', '×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×¤×—×”: ' + error.toString(), 'loginMessage');
    }
}


// ×—×–×¨×” ×œ××©×¤×—×” ×¢×œ×™×•× ×”
function returnToParentFamily() {
    console.log('returnToParentFamily × ×§×¨××”');
    console.log('××—×¡× ×™×ª × ×•×›×—×™×ª:', parentFamilyStack);
    
    if (parentFamilyStack.length === 0) {
        // ××™×Ÿ ××©×¤×—×” ×œ×—×–×•×¨ ××œ×™×” - ×—×–×•×¨ ×œ××©×¤×—×” ×”××§×•×¨×™×ª ×©×œ ×”××©×ª××©
        console.log('×—×•×–×¨ ×œ××©×¤×—×” ×”××§×•×¨×™×ª ×©×œ ×”××©×ª××©:', currentUser.familyNumber);
        loadUserFamilyFromSheets(null, currentUser.familyNumber);
        return;
    }
    
    // ×—×–×•×¨ ×œ××©×¤×—×” ×”××§×•×¨×™×ª (×ª××™×“ ×”×¨××©×•× ×” ×‘××—×¡× ×™×ª)
    const originalFamilyNumber = parentFamilyStack[0];
    
    // × ×§×” ××ª ×”××—×¡× ×™×ª
    parentFamilyStack = [];
    
    console.log('×—×•×–×¨ ×œ××©×¤×—×” ×”××§×•×¨×™×ª:', originalFamilyNumber);
    
    // ×”×¡×ª×¨ ××ª ×œ×—×¦×Ÿ ×”×—×–×¨×”
    const returnButton = document.getElementById('returnButton');
    if (returnButton) {
        returnButton.style.display = 'none';
    }
    
    // ×˜×¢×Ÿ ××ª ×”××©×¤×—×” ×”××§×•×¨×™×ª
    loadUserFamilyFromSheets(null, originalFamilyNumber);
}

// ===== ×™×¦×™×¨×ª ×ª×•×›×Ÿ ××©×¤×—×” (×œ×©×™××•×© ×—×•×–×¨) =====
function createFamilyContentHTML(family) {
    const singleChildren = family.children ? family.children.filter(child => 
        !child['× ×©×•×™/×¨×•×•×§'] || child['× ×©×•×™/×¨×•×•×§'].includes('×¨×•×•×§')
    ).sort((a, b) => {
        const aNum = parseInt(a.××¡×¤×¨_×‘×Ÿ) || 999;
        const bNum = parseInt(b.××¡×¤×¨_×‘×Ÿ) || 999;
        return aNum - bNum;
    }) : [];

    const marriedChildren = family.children ? family.children.filter(child => 
        child['× ×©×•×™/×¨×•×•×§'] && !child['× ×©×•×™/×¨×•×•×§'].includes('×¨×•×•×§')
    ).sort((a, b) => {
        const aNum = parseInt(a.××¡×¤×¨_×‘×Ÿ) || 999;
        const bNum = parseInt(b.××¡×¤×¨_×‘×Ÿ) || 999;
        return aNum - bNum;
    }) : [];

    return `
        <!-- ×”×”×•×¨×™× -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- ×”××‘ -->
            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 12px; border: 2px solid #2196F3;">
                <h3 style="margin-top: 0; color: #1565c0; text-align: center;">ğŸ‘¨ ×”×‘×¢×œ</h3>
                ${family.father ? `
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">${family.father.×©×_×¤×¨×˜×™} ${family.father.×©×_××©×¤×—×”}</div>
                        <div style="font-size: 0.85em; color: #666; line-height: 1.4;">
                            <div>ğŸ†” ${family.father.××¡×¤×¨_××™×©×™}</div>
                            ${family.father.×ª××¨×™×š_×œ×™×“×” ? `<div>ğŸ‚ ${family.father.×ª××¨×™×š_×œ×™×“×”}</div>` : ''}
                            ${family.father.×©×_×× ? `<div>ğŸ‘© ${family.father.×©×_××}</div>` : ''}
                        </div>
                    </div>
                ` : '<div style="text-align: center; color: #999;">××™×Ÿ × ×ª×•× ×™ ×‘×¢×œ</div>'}
            </div>

            <!-- ×”××™×©×” -->
            <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 20px; border-radius: 12px; border: 2px solid #e91e63;">
                <h3 style="margin-top: 0; color: #c2185b; text-align: center;">ğŸ‘© ×”××™×©×”</h3>
                ${family.mother ? `
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">${family.mother.×©×_×¤×¨×˜×™} ${family.mother.×©×_××©×¤×—×”}</div>
                        <div style="font-size: 0.85em; color: #666; line-height: 1.4;">
                            <div>ğŸ†” ${family.mother.××¡×¤×¨_××™×©×™}</div>
                            ${family.mother.×ª××¨×™×š_×œ×™×“×” ? `<div>ğŸ‚ ${family.mother.×ª××¨×™×š_×œ×™×“×”}</div>` : ''}
                            ${family.mother.×©×_×× ? `<div>ğŸ‘© ${family.mother.×©×_××}</div>` : ''}
                            ${family.mother.×ª××¨×™×š_× ×©×•××™×Ÿ ? `<div>ğŸ’’ ${family.mother.×ª××¨×™×š_× ×©×•××™×Ÿ}</div>` : ''}
                        </div>
                    </div>
                ` : '<div style="text-align: center; color: #999;">××™×Ÿ × ×ª×•× ×™ ××™×©×”</div>'}
            </div>
        </div>

        <!-- ×™×œ×“×™× ×¨×•×•×§×™× -->
        ${singleChildren.length > 0 ? `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #ff6f00; margin-bottom: 15px; text-align: center;">ğŸ‘¶ ×™×œ×“×™× ×¨×•×•×§×™× (${singleChildren.length})</h3>
                <div style="display: grid; gap: 10px;">
                    ${singleChildren.map(child => createSimpleChildCard(child, 'single')).join('')}
                </div>
            </div>
        ` : ''}

        <!-- ×™×œ×“×™× × ×©×•××™× -->
        ${marriedChildren.length > 0 ? `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #2e7d32; margin-bottom: 15px; text-align: center;">ğŸ’’ ×™×œ×“×™× × ×©×•××™× (${marriedChildren.length})</h3>
                <div style="display: grid; gap: 10px;">
                    ${marriedChildren.map(child => createSimpleChildCard(child, 'married')).join('')}
                </div>
            </div>
        ` : ''}

        ${singleChildren.length === 0 && marriedChildren.length === 0 ? `
            <div style="text-align: center; color: #666; padding: 20px; font-style: italic;">××™×Ÿ ×™×œ×“×™× ×¨×©×•××™×</div>
        ` : ''}
    `;
}

// ===== ×™×¦×™××” ××”××¢×¨×›×ª =====
function logoutUser() {
    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¦××ª ××”××¢×¨×›×ª?')) {
        // ×”×¡×¨×ª ×ª×¦×•×’×ª ×”××©×¤×—×”
        const familyContainer = document.getElementById('familyViewContainer');
        if (familyContainer) {
            familyContainer.remove();
        }
        
        // ×”×¦×’×ª ×˜×•×¤×¡ ×”×”×ª×—×‘×¨×•×ª ××—×“×©
        document.getElementById('loginContainer').style.display = 'block';
        
        // × ×™×§×•×™ ××©×ª× ×™×
        currentUserEmail = '';
        currentUserName = '';
        currentFamilyNumber = null;
        
        showMessage('info', '×™×¦××ª ××”××¢×¨×›×ª ×‘×”×¦×œ×—×”', 'loginMessage');
    }
}

// ===== ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× =====
let currentUserEmail = '';
let currentUserName = '';
let currentFamilyNumber = null;
    </script>
</body>
</html>
