<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כוללות צעטיל - אתר המשפחות</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        /* טפסי הרשמה וכניסה */
        .auth-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 25px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .form-toggle button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .form-toggle button.active {
            background: #4CAF50;
            color: white;
        }

        .auth-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        /* ממשק המשפחה */
        .family-dashboard {
            display: none;
        }

        .user-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info h2 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .family-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .family-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .family-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .family-number {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .parents-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .parent-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .parent-card.father {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .parent-card.mother {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        }

        .parent-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .parent-details {
            font-size: 14px;
            color: #666;
        }

        .children-section {
            margin-top: 20px;
        }

        .children-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .children-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .add-child-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .children-list {
            display: grid;
            gap: 10px;
        }

        .child-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
        }

        .child-item.pending {
            background: #fff8e1;
            border-color: #ffa000;
            opacity: 0.7;
        }

        .child-item.approved {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .child-info {
            flex: 1;
        }

        .child-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .child-details {
            font-size: 12px;
            color: #666;
        }

        .child-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        /* מודל הוספת ילד */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* הודעות */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* טעינה */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* רספונסיב */
        @media (max-width: 768px) {
            .parents-section {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .children-header {
                flex-direction: column;
                gap: 10px;
            }

            .child-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* סטטוס חיבור */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.loading {
            background: #ff9800;
            color: white;
        }

        /* לחצן הפניה להרשמה */
        .redirect-to-register {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
        }

        .redirect-to-register:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status loading">🔄 מתחבר...</div>

    <div class="container">
        <div class="header">
            <h1>🏠 כוללות צעטיל</h1>
            <p>אתר המשפחות הרשמי - צפיה במשפחה והוספת ילדים</p>
        </div>

        <div class="content">
            <!-- מסך הרשמה וכניסה -->
            <div id="authSection" class="auth-container">
                <!-- כפתורי החלפה -->
                <div class="form-toggle">
                    <button id="loginTab" class="active" onclick="showLoginForm()">כניסה</button>
                    <button id="registerTab" onclick="showRegisterForm()">הרשמה</button>
                </div>

                <!-- טופס כניסה -->
                <div id="loginForm" class="auth-form">
                    <h2 style="text-align: center; margin-bottom: 20px;">🔐 כניסה למערכת</h2>
                    
                    <div class="form-group">
                        <label>מספר תעודת זהות</label>
                        <input type="text" id="loginId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>מספר טלפון</label>
                        <input type="tel" id="loginPhone" placeholder="050-1234567" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="loginUser()">
                        🚪 כניסה למערכת
                    </button>

                    <div id="loginMessage"></div>
                </div>

                <!-- טופס הרשמה -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2 style="text-align: center; margin-bottom: 20px;">📝 הרשמה חדשה</h2>
                    
                    <div class="form-group">
                        <label>שם פרטי *</label>
                        <input type="text" id="regFirstName" required>
                    </div>

                    <div class="form-group">
                        <label>שם משפחה *</label>
                        <input type="text" id="regLastName" required>
                    </div>

                    <div class="form-group">
                        <label>מספר תעודת זהות *</label>
                        <input type="text" id="regId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>שם האב *</label>
                        <input type="text" id="regFatherName" required>
                    </div>

                    <div class="form-group">
                        <label>שם האם *</label>
                        <input type="text" id="regMotherName" required>
                    </div>

                    <div class="form-group">
                        <label>מספר טלפון *</label>
                        <input type="tel" id="regPhone" placeholder="050-1234567" required>
                    </div>

                    <div class="form-group">
                        <label>כתובת מייל *</label>
                        <input type="email" id="regEmail" placeholder="example@email.com" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="registerUser()">
                        📧 שלח בקשת הרשמה
                    </button>

                    <div id="registerMessage"></div>

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                        <strong>📋 תהליך ההרשמה:</strong><br>
                        1. מלא את הפרטים ושלח בקשה<br>
                        2. המערכת תשלח את הנתונים למנהל<br>
                        3. לאחר אישור המנהל תקבל מייל אימות<br>
                        4. לחץ על הקישור במייל לאימות<br>
                        5. לאחר האימות תוכל להתחבר עם ת.ז. וטלפון
                    </div>
                </div>
            </div>

            <!-- מסך המשפחה -->
            <div id="familyDashboard" class="family-dashboard">
                <button class="logout-btn" onclick="logout()">🚪 יציאה</button>

                <div id="userInfo" class="user-info">
                    <!-- מידע המשתמש יטען כאן -->
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>טוען נתוני המשפחה...</p>
                </div>

                <div id="familyContent">
                    <!-- תוכן המשפחה יטען כאן -->
                </div>
            </div>
        </div>
    </div>

    <!-- מודל הוספת ילד -->
    <div id="addChildModal" class="modal-overlay">
        <div class="modal-content">
            <h2>👶 הוספת ילד חדש</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>שם פרטי *</label>
                    <input type="text" id="childFirstName" required>
                </div>

                <div class="form-group">
                    <label>מין *</label>
                    <select id="childGender" required>
                        <option value="">בחר מין</option>
                        <option value="זכר">זכר</option>
                        <option value="נקבה">נקבה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>תאריך לידה עברי</label>
                    <input type="text" id="childBirthDate" placeholder="כ״ג אלול תשפ״ד">
                </div>

                <div class="form-group">
                    <label>שם האם</label>
                    <input type="text" id="childMotherName">
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>הערות</label>
                <textarea id="childNotes" rows="3" placeholder="הערות נוספות..."></textarea>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                <strong>⚠️ שים לב:</strong> הילד יתווסף למערכת אך יהיה במצב "ממתין לאישור" עד שהמנהל יאשר את הוספתו.
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveChild()">
                    💾 הוסף ילד
                </button>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 10px;">
                    ❌ ביטול
                </button>
            </div>

            <div id="childMessage"></div>
        </div>
    </div>

    <script>
        // ===== הגדרות חיבור לגוגל שיטס =====
        
        // 🔧 החלף את הערכים האלה בערכים שלך
        const GOOGLE_SHEETS_CONFIG = {
            API_KEY: 'AIzaSyADMdfuBJtqpzH2h5CVr9FxkBn2Eb5oigc',
            SPREADSHEET_ID: '1dLTsow7grSW3S8ggtRsmPrL-Huir_C-Bhw97gul2yog',
            RANGES: {
                MEMBERS: 'כוללות_צעטיל!A:AD',
                REGISTRATIONS: 'נתוני_החברים!A:K', // עדכון לכלול עמודות A-K
                PENDING_CHILDREN: 'ילדים_ממתינים!A:J'
            }
        };

        // URL של Google Apps Script
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8kJdoUvL7tKNlHOYfpxpRntDQqpY4q27jc8v95N4pSdqM9dJ5n53F_fEN7QIeoQ/exec';

        // ===== משתנים גלובליים =====
        let currentUser = null;
        let allMembers = [];
        let userFamily = null;
        let isConnected = false;

        // ===== אתחול =====
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('loading');
            initializeApp();
        });

        async function initializeApp() {
            try {
                updateConnectionStatus('loading');
                
                console.log('🔄 בודק חיבור לגוגל שיטס...');
                await testGoogleSheetsConnection();
                
                console.log('🔄 בודק חיבור לגוגל אפס סקריפט...');
                const scriptWorking = await testGoogleAppsScript();
                
                if (scriptWorking) {
                    console.log('✅ כל המערכות עובדות');
                    updateConnectionStatus('connected');
                } else {
                    console.warn('⚠️ יש בעיה עם Google Apps Script');
                    updateConnectionStatus('disconnected');
                    showMessage('warning', 'יש בעיה בחיבור לשרת. פונקציות הכתיבה עלולות לא לעבוד.', 'loginMessage');
                }
                
                isConnected = true;
                                
            } catch (error) {
                console.error('❌ שגיאה באתחול:', error);
                updateConnectionStatus('disconnected');
                showMessage('error', 'אין חיבור לשרת. נסה לרענן את הדף.', 'loginMessage');
            }
        }

        // ===== פונקציות חיבור =====
        async function testGoogleSheetsConnection() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        async function testGoogleAppsScript() {
            try {
                console.log('🔄 בודק חיבור ל-Google Apps Script...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                console.log('✅ חיבור ל-Google Apps Script עובד');
                return true;
                
            } catch (error) {
                console.error('❌ בעיה בחיבור ל-Google Apps Script:', error);
                return false;
            }
        }

        async function readFromGoogleSheets(range) {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${range}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('שגיאה בקריאה מהגיליון:', error);
                throw error;
            }
        }

        async function writeToGoogleSheets(range, values) {
            try {
                console.log('שולח נתונים ל-Google Sheets:', { range, values });
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'write',
                        range: range,
                        values: values
                    })
                });

                console.log('✅ נתונים נשלחו ל-Google Sheets');
                return { success: true };

            } catch (error) {
                console.error('❌ שגיאה בכתיבה ל-Google Sheets:', error);
                throw new Error(`שגיאה בשליחת הנתונים: ${error.message}`);
            }
        }

        // ===== הרשמה מעודכנת =====
        async function registerUser() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const idNumber = document.getElementById('regId').value.trim();
            const fatherName = document.getElementById('regFatherName').value.trim();
            const motherName = document.getElementById('regMotherName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();

            // וידוא שדות
            if (!firstName || !lastName || !idNumber || !fatherName || !motherName || !phone || !email) {
                showMessage('error', 'יש למלא את כל השדות החובה', 'registerMessage');
                return;
            }

            // וידוא ת.ז.
            if (!/^\d{9}$/.test(idNumber)) {
                showMessage('error', 'מספר תעודת זהות חייב להכיל 9 ספרות', 'registerMessage');
                return;
            }

            // וידוא מייל
            if (!/\S+@\S+\.\S+/.test(email)) {
                showMessage('error', 'כתובת מייל לא תקינה', 'registerMessage');
                return;
            }

            try {
                showMessage('info', '🔄 שולח בקשת הרשמה...', 'registerMessage');

                // בדיקה אם המשתמש כבר קיים
                console.log('🔍 בודק אם המשתמש קיים...');
                const existingRegistrations = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);
                
                const userExists = existingRegistrations.some(row => 
                    row[2] === idNumber || row[5] === phone || row[6] === email
                );

                if (userExists) {
                    showMessage('error', 'משתמש עם הפרטים האלה כבר קיים במערכת', 'registerMessage');
                    return;
                }

                // הכנת הנתונים לשליחה - מסודר לפי העמודות הנכונות
                const timestamp = new Date().toISOString();
                
                const newRegistration = [
    firstName,                              // עמודה A - שם פרטי
    lastName,                               // עמודה B - שם משפחה  
    email,                                  // עמודה C - כתובת מייל
    idNumber + "\u200B",                         // עמודה D - מס' ת.ז.
    phone + "\u200B",                            // עמודה E - מספר טלפון
    `${firstName} בן ${motherName}`,        // עמודה F - שם מלא
    timestamp,                              // עמודה G - תאריך רישום
    'ממתין לאימות',                        // עמודה H - סטטוס אישור
    'ממתין לאימות',                        // עמודה I - סטטוס אימות
    '',                                     // עמודה J - אימות מנהל
    '',                                     // עמודה K - הערות
    '',                                     // עמודה L - מספר משפחה
    fatherName,                             // עמודה M - שם אב
    motherName                              // עמודה N - שם אם
];

                console.log('📤 שולח נתוני הרשמה:', newRegistration);

                // שליחת הנתונים לגיליון
                await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS, [newRegistration]);
                
                console.log('✅ נתונים נשלחו בהצלחה ל-Google Sheets');

                // הודעת הצלחה
                showMessage('success', 
                    `✅ <strong>בקשת ההרשמה נשלחה בהצלחה!</strong><br><br>
                    📋 הנתונים נשלחו למנהל המערכת לבדיקה<br>
                    📧 לאחר אישור המנהל תקבל מייל אימות לכתובת: ${email}<br>
                    🔗 לחץ על הקישור במייל כדי לאמת את החשבון<br>
                    ✅ לאחר האימות תוכל להתחבר עם ת.ז. וטלפון<br><br>
                    <small>זמן שליחה: ${new Date().toLocaleString('he-IL')}</small>`, 
                    'registerMessage'
                );

                // ניקוי הטופס
                document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');

                console.log('✅ תהליך ההרשמה הושלם בהצלחה');

            } catch (error) {
                console.error('❌ שגיאה בתהליך ההרשמה:', error);
                showMessage('error', 
                    `❌ <strong>שגיאה בתהליך ההרשמה</strong><br>
                    ${error.message || 'שגיאה לא מזוהה'}<br>
                    אנא נסה שוב או פנה למנהל המערכת`, 
                    'registerMessage'
                );
            }
        }

        // ===== כניסה מעודכנת =====
        async function loginUser() {
            const idNumber = document.getElementById('loginId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();

            if (!idNumber || !phone) {
                showMessage('error', 'יש למלא מספר ת.ז. וטלפון', 'loginMessage');
                return;
            }

            if (!/^\d{9}$/.test(idNumber)) {
                showMessage('error', 'מספר תעודת זהות חייב להכיל 9 ספרות', 'loginMessage');
                return;
            }

            try {
                showMessage('info', 'מתחבר למערכת...', 'loginMessage');

                // קריאת נתוני ההרשמות
               const registrations = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);

// הוסף את זה לבדיקה:
console.log('רשימת כל הנתונים:', registrations);
console.log('מחפש ת.ז.:', idNumber);
console.log('מחפש טלפון:', phone);

// בדיקה מדויקת יותר
registrations.slice(1).forEach((row, index) => {
    const rowId = row[3]?.toString().trim();
    const rowPhone = row[4]?.toString().trim();
    
    console.log(`שורה ${index + 1}:`);
    console.log(`  ת.ז. בגיליון: "${rowId}" (אורך: ${rowId?.length})`);
    console.log(`  ת.ז. שהוקלד: "${idNumber}" (אורך: ${idNumber.length})`);
    console.log(`  תואם ת.ז.: ${rowId === idNumber}`);
    
    console.log(`  טלפון בגיליון: "${rowPhone}" (אורך: ${rowPhone?.length})`);
    console.log(`  טלפון שהוקלד: "${phone}" (אורך: ${phone.length})`);
    console.log(`  תואם טלפון: ${rowPhone === phone}`);
    console.log('---');
});
// חיפוש המשתמש
// חיפוש המשתמש (מדלג על שורת כותרות)
const userRegistration = registrations.slice(1).find(row => {
    const rowId = row[3]?.toString().replace(/\s/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/[^\d]/g, '');
    const rowPhone = row[4]?.toString().replace(/\s/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/[^\d]/g, '');
    
    // הוסף את זה לבדיקה:
    console.log('אחרי ניקוי:');
    console.log(`ת.ז. מנוקה: "${rowId}" (אורך: ${rowId.length})`);
    console.log(`טלפון מנוקה: "${rowPhone}" (אורך: ${rowPhone.length})`);
    console.log(`התאמה: ${rowId === idNumber && rowPhone === phone}`);
    
    return rowId === idNumber && rowPhone === phone;
});
console.log('תוצאת החיפוש:', userRegistration);

                if (!userRegistration) {
                    // המשתמש לא נמצא בכלל
                    showMessage('error', 
                        `❌ <strong>לא נמצא משתמש עם הפרטים האלה</strong><br><br>
                        יתכן שעדיין לא נרשמת למערכת:`, 
                        'loginMessage'
                    );
                    
                    // הוספת כפתור הפניה להרשמה
                    setTimeout(() => {
                        const loginMessageDiv = document.getElementById('loginMessage');
                        const registerBtn = document.createElement('button');
                        registerBtn.className = 'redirect-to-register';
                        registerBtn.textContent = '📝 לחץ כאן להרשמה';
                        registerBtn.onclick = () => {
                            showRegisterForm();
                            loginMessageDiv.innerHTML = '';
                        };
                        loginMessageDiv.appendChild(registerBtn);
                    }, 100);
                    
                    return;
                }

                // בדיקת סטטוס האימות
                const verificationStatus = userRegistration[9]; // עמודה J
const approvalStatus = userRegistration[7];     // עמודה H - הוסף את זה

if (verificationStatus !== 'אומת') {
    let statusMessage = '';
    
    if (approvalStatus === 'ממתין לאימות') {  // שנה לבדוק עמודה H
        statusMessage = `⏳ <strong>החשבון שלך עדיין לא אומת</strong><br><br>
        📋 הרשמתך נקלטה במערכת אך עדיין ממתינה לאישור המנהל<br>
        📧 לאחר אישור המנהל תקבל מייל אימות<br>
        🔗 תצטרך ללחוץ על הקישור במייל כדי לאמת את החשבון<br><br>
        אם חלף זמן רב ולא קיבלת מייל, פנה למנהל המערכת.`;
    } else {
        statusMessage = `❌ <strong>החשבון שלך לא אומת</strong><br><br>
        סטטוס נוכחי: ${verificationStatus}<br>
        יש לאמת את החשבון לפני הכניסה למערכת.<br><br>
        אם יש בעיה, פנה למנהל המערכת.`;
    }
                    
                    showMessage('warning', statusMessage, 'loginMessage');
                    
                    // הוספת כפתור הפניה להרשמה
                    setTimeout(() => {
                        const loginMessageDiv = document.getElementById('loginMessage');
                        const registerBtn = document.createElement('button');
                        registerBtn.className = 'redirect-to-register';
                        registerBtn.textContent = '📝 אולי תרצה להירשם שוב?';
                        registerBtn.onclick = () => {
                            showRegisterForm();
                            loginMessageDiv.innerHTML = '';
                        };
                        loginMessageDiv.appendChild(registerBtn);
                    }, 100);
                    
                    return;
                }

                // המשתמש מאומת - מתחבר
                currentUser = {
    firstName: userRegistration[0],
    lastName: userRegistration[1], 
    idNumber: userRegistration[2],
    fatherName: userRegistration[3],
    motherName: userRegistration[4],
    phone: userRegistration[5],
    email: userRegistration[6],
    familyNumber: userRegistration[10] // עמודה K - מספר משפחה
};

// מעבר לתצוגת המשפחה
showUserFamily(userRegistration[6]);

            } catch (error) {
                console.error('שגיאה בכניסה:', error);
                showMessage('error', 'שגיאה בהתחברות. נסה שוב מאוחר יותר.', 'loginMessage');
            }
        }

        // ===== ממשק המשפחה =====
        async function loadUserDashboard() {
            try {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('familyDashboard').style.display = 'block';
                document.getElementById('loading').style.display = 'block';

                // עדכון מידע המשתמש
                document.getElementById('userInfo').innerHTML = `
                    <h2>שלום ${currentUser.firstName} ${currentUser.lastName}</h2>
                    <p>📧 ${currentUser.email} | 📱 ${currentUser.phone}</p>
                    <p>בן ${currentUser.motherName} ואבי ${currentUser.fatherName}</p>
                    ${currentUser.familyNumber ? `<p><strong>מספר משפחה: ${currentUser.familyNumber}</strong></p>` : ''}
                `;

                // אם יש מספר משפחה - הצג את המשפחה
                if (currentUser.familyNumber) {
                    await loadMembersData();
                    await findUserFamily();
                    displayUserFamily();
                } else {
                    // אין מספר משפחה - הודעה למשתמש
                    document.getElementById('familyContent').innerHTML = `
                        <div class="message warning">
                            <h3>⚠️ מספר משפחה לא הוגדר</h3>
                            <p>עדיין לא הוגדר מספר משפחה עבור החשבון שלך.</p>
                            <p>אנא פנה למנהל המערכת להשלמת הפרטים.</p>
                        </div>
                    `;
                }

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('שגיאה בטעינת הממשק:', error);
                showMessage('error', 'שגיאה בטעינת נתוני המשפחה', 'familyContent');
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadMembersData() {
            const membersData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
            
            if (membersData.length > 1) {
                const headers = membersData[0];
                allMembers = membersData.slice(1).map(row => {
                    const member = {};
                    headers.forEach((header, index) => {
                        member[header] = row[index] || '';
                    });
                    return member;
                });
            }
        }

        async function findUserFamily() {
            if (currentUser.familyNumber) {
                userFamily = await buildFamilyStructure(currentUser.familyNumber);
            }
        }

        async function buildFamilyStructure(familyNumber) {
            const father = allMembers.find(m => 
                parseInt(m.משפ_עצמי) === parseInt(familyNumber) && m.ראש_משפחה === 'TRUE'
            );

            const mother = allMembers.find(m => 
                parseInt(m.מספר_הזוג) === parseInt(father?.מספר_אישי)
            );

            const children = allMembers.filter(m => 
                parseInt(m.משפ_הורים) === parseInt(familyNumber)
            ).sort((a, b) => {
                const aNum = parseInt(a.מספר_בן) || 999;
                const bNum = parseInt(b.מספר_בן) || 999;
                return aNum - bNum;
            });

            return {
                familyNumber: familyNumber,
                father: father,
                mother: mother,
                children: children,
                lastName: father?.שם_משפחה || mother?.שם_משפחה,
                marriageDate: father?.תאריך_נשואין
            };
        }

        
        function createChildCard(child) {
            const benBat = child.מין === 'זכר' ? 'בן' : 'בת';
            const motherName = child.שם_אם || userFamily.mother?.שם_פרטי || '';
            const fullChildName = motherName ? `${child.שם_פרטי} ${benBat} ${motherName}` : child.שם_פרטי;
            
            const isApproved = child.מאושר !== 'ממתין לאישור';
            
            return `
                <div class="child-item ${isApproved ? 'approved' : 'pending'}">
                    <div class="child-info">
                        <div class="child-name">
                            ${child.מספר_בן ? `${child.מספר_בן}. ` : ''}${fullChildName}
                        </div>
                        <div class="child-details">
                            ${child.מין} • מספר ${child.מספר_אישי}
                            ${child.תאריך_לידה ? ` • ${child.תאריך_לידה}` : ''}
                            ${child.הערה ? ` • ${child.הערה}` : ''}
                        </div>
                    </div>
                    <div class="child-status ${isApproved ? 'status-approved' : 'status-pending'}">
                        ${isApproved ? '✅ מאושר' : '⏳ ממתין לאישור'}
                    </div>
                </div>
            `;
        }

        // ===== הוספת ילד =====
        function openAddChildModal() {
            document.getElementById('addChildModal').style.display = 'flex';
            
            const motherName = userFamily.mother?.שם_פרטי || '';
            document.getElementById('childMotherName').value = motherName;
        }

        async function saveChild() {
            const firstName = document.getElementById('childFirstName').value.trim();
            const gender = document.getElementById('childGender').value;
            const birthDate = document.getElementById('childBirthDate').value.trim();
            const motherName = document.getElementById('childMotherName').value.trim();
            const notes = document.getElementById('childNotes').value.trim();

            if (!firstName || !gender) {
                showMessage('error', 'יש למלא שם פרטי ומין', 'childMessage');
                return;
            }

            try {
                showMessage('info', 'שומר ילד...', 'childMessage');

                const maxChildNumber = userFamily.children.reduce((max, child) => {
                    const num = parseInt(child.מספר_בן) || 0;
                    return num > max ? num : max;
                }, 0);

                const nextChildNumber = maxChildNumber + 1;

                const childData = [
                    firstName,
                    userFamily.lastName,
                    gender,
                    birthDate,
                    notes,
                    motherName,
                    userFamily.familyNumber,
                    nextChildNumber,
                    new Date().toISOString(),
                    'ממתין לאישור'
                ];

                await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.PENDING_CHILDREN, [childData]);

                showMessage('success', 
                    `הילד ${firstName} נוסף בהצלחה!<br>הוא ממתין כעת לאישור המנהל.`, 
                    'childMessage'
                );

                document.getElementById('childFirstName').value = '';
                document.getElementById('childGender').value = '';
                document.getElementById('childBirthDate').value = '';
                document.getElementById('childNotes').value = '';

                setTimeout(async () => {
                    closeModal();
                    showUserFamily(currentUser.email);
                }, 2000);

            } catch (error) {
                console.error('שגיאה בהוספת הילד:', error);
                showMessage('error', 'שגיאה בשמירת הילד. נסה שוב מאוחר יותר.', 'childMessage');
            }
        }

        // ===== ממשק משתמש =====
        function showLoginForm() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginMessage').innerHTML = '';
        }

        function showRegisterForm() {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registerMessage').innerHTML = '';
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = '✅ מחובר';
                    break;
                case 'disconnected':
                    statusElement.textContent = '❌ לא מחובר';
                    break;
                case 'loading':
                    statusElement.textContent = '🔄 מתחבר...';
                    break;
            }
        }

        function showMessage(type, message, elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                if (element.innerHTML.includes(message)) {
                    element.innerHTML = '';
                }
            }, 15000);
        }

        function closeModal() {
            document.getElementById('addChildModal').style.display = 'none';
            document.getElementById('childMessage').innerHTML = '';
        }

        function logout() {
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                localStorage.removeItem('familyUser');
                currentUser = null;
                userFamily = null;
                
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('familyDashboard').style.display = 'none';
                
                document.querySelectorAll('#loginForm input').forEach(input => input.value = '');
                document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');
                
                showLoginForm();
            }
        }

        // ===== האזנה לאירועים =====
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // וידוא מספרים בלבד בת.ז.
        document.addEventListener('DOMContentLoaded', function() {
            const idInputs = ['regId', 'loginId'];
            idInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function(e) {
                        this.value = this.value.replace(/\D/g, '');
                    });
                }
            });
        });
        // ===== הצגת משפחת המשתמש אחרי התחברות מוצלחת =====
function showUserFamily(userEmail) {
    showMessage('info', '🔄 טוען את המשפחה שלך...', 'loginMessage');
    
    // במקום google.script.run, נשתמש בפונקציות הקיימות שלך
    loadUserFamilyFromSheets(userEmail);
}

async function loadUserFamilyFromSheets(userEmail) {
    try {
        // קבלת מספר המשפחה של המשתמש
        const familyNumber = currentUser.familyNumber; // כבר יש לנו במשתנה currentUser
        
        console.log('מספר משפחה שנמצא:', familyNumber); // הוסף את זה
        
        if (!familyNumber) {
            showMessage('warning', 'לא נמצא מספר משפחה עבורך. פנה למנהל המערכת.', 'loginMessage');
            return;
        }
        
        console.log('קורא נתונים מגליון כוללות_צעטיל...'); // הוסף את זה
        
        // קריאת נתוני משפחה מגליון כוללות_צעטיל
        const familyData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
        
        console.log('נתונים שהתקבלו:', familyData?.length, 'שורות'); // הוסף את זה
        
        const processedFamilyData = organizeFamilyDataFromSheets(familyData, familyNumber);
        
        console.log('נתוני משפחה מעובדים:', processedFamilyData); // הוסף את זה
        
        if (processedFamilyData) {
            displayUserFamily(processedFamilyData);
        } else {
            showMessage('error', 'לא נמצאו נתוני משפחה מספר: ' + familyNumber, 'loginMessage');
        }
        
    } catch (error) {
        console.error('שגיאה בטעינת המשפחה:', error);
        showMessage('error', 'שגיאה בטעינת המשפחה: ' + error.toString(), 'loginMessage');
    }
}

function organizeFamilyDataFromSheets(data, familyNumber) {
    if (!data || data.length === 0) return null;
    
    const familyMembers = [];
    
    console.log('מחפש משפחה מספר:', familyNumber, 'טיפוס:', typeof familyNumber);
    
    // חיפוש כל חברי המשפחה (מדלג על שורת כותרות)
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const ownFamily = row[24]; // עמודה Y - משפ_עצמי
        const parentsFamily = row[25]; // עמודה Z - משפ_הורים
        
        if (ownFamily == familyNumber || parentsFamily == familyNumber) {
            console.log('נמצא חבר משפחה:', {
                שם: row[1],
                מין: row[3],
                משפ_עצמי: ownFamily,
                משפ_הורים: parentsFamily,
                ראש_משפחה: row[22] // עמודה W
            });
            
            familyMembers.push({
   
    מספר_אישי: row[0],             // A  
    שם_פרטי: row[1],               // B  
    שם_אם: row[2],                 // C  
    שם_משפחה: row[3],             // D  
    מין: row[4],                   // E  
    תאריך_לידה: row[5],           // F  
    תאריך_נשואין: row[6],         // G  
    פעיל: row[7],                  // H  
    נשוי_רווק: row[8],            // I  
    הערה: row[9],                  // J  
    מספר_הזוג: row[10],           // K  
    מספר_אב: row[11],             // L  
    מספר_אם: row[12],             // M  
    תאריך_כניסה: row[13],         // N  
    שעת_כניסה: row[14],           // O  
    הערה_פעילה: row[15],          // P  
    מגורים: row[16],              // Q  
    לא_אנש: row[17],               // R  
    מספר_בן: row[18],             // S  
    זוג: row[19],                  // T  
    בנם: row[20],                  // U  
    מיון: row[21],                 // V  
    ראש_משפחה: row[22],           // W  
    בן_בת: row[23],               // X  
    משפ_עצמי: row[24],            // Y  
    משפ_הורים: row[25],           // Z  
    פרשה_בשמחת_עולם: row[26],     // AA  
    הוגה_בתשסג: row[27],           // AB  
    עיר_מגורים: row[28],          // AC  
    הוגה_תשעד: row[29]            // AD
});
                  }
    }
    
    console.log('סה"כ חברי משפחה נמצאו:', familyMembers.length);
    
    // ארגון נתוני המשפחה
    const parents = familyMembers.filter(m => m.משפ_עצמי == familyNumber);
    console.log('הורים נמצאו:', parents.length, parents);
    
    const father = parents.find(p => p.מין === 'זכר');
    const mother = parents.find(p => p.מין === 'נקבה');
    const children = familyMembers.filter(m => m.משפ_הורים == familyNumber);
    
    console.log('אב:', father?.שם_פרטי);
    console.log('אם:', mother?.שם_פרטי);
    console.log('ילדים:', children.length);
    
    return {
        familyNumber: familyNumber,
        lastName: father?.שם_משפחה || mother?.שם_משפחה || '',
        city: father?.עיר_מגורים || mother?.עיר_מגורים || '',
        father: father,
        mother: mother,
        children: children
    };
}
// ===== טעינת נתוני המשפחה =====
function loadUserFamilyData(familyNumber) {
    google.script.run
        .withSuccessHandler(function(familyData) {
            if (familyData) {
                displayUserFamily(familyData);
            } else {
                showMessage('error', 'לא נמצאו נתוני משפחה מספר: ' + familyNumber, 'loginMessage');
            }
        })
        .withFailureHandler(function(error) {
            showMessage('error', 'שגיאה בטעינת המשפחה: ' + error.toString(), 'loginMessage');
        })
        .getUserFamilyData(familyNumber);
}

// ===== הצגת המשפחה =====
function displayUserFamily(familyData, isChildFamily = false) {
    console.log('displayUserFamily נקראה עם:', familyData);
    console.log('האם זו משפחת ילד?', isChildFamily);
    
    // מחיקת תצוגת משפחה קודמת אם קיימת
    const existingContainer = document.getElementById('familyViewContainer');
    if (existingContainer) {
        existingContainer.remove();
    }
    
    // הסתרת טופס ההתחברות
    const forms = document.querySelectorAll('[class*="container"], [id*="login"], [id*="form"]');
    forms.forEach(form => {
        if (form.style.display !== 'none') {
            form.style.display = 'none';
        }
    });
    
    // יצירת תצוגת המשפחה
    const familyContainer = document.createElement('div');
    familyContainer.id = 'familyViewContainer';
    familyContainer.innerHTML = createFamilyViewHTML(familyData, isChildFamily);
    
    document.body.appendChild(familyContainer);
    
    console.log('המשפחה הוצגה בהצלחה');
}

// ===== יצירת HTML לתצוגת המשפחה =====
function createFamilyViewHTML(family) {
    // הפרדת ילדים לרווקים ונשואים
    const singleChildren = family.children ? family.children.filter(child => 
        !child['נשוי/רווק'] || child['נשוי/רווק'].includes('רווק')
    ).sort((a, b) => {
        const aNum = parseInt(a.מספר_בן) || 999;
        const bNum = parseInt(b.מספר_בן) || 999;
        return aNum - bNum;
    }) : [];

    const marriedChildren = family.children ? family.children.filter(child => 
        child['נשוי/רווק'] && !child['נשוי/רווק'].includes('רווק')
    ).sort((a, b) => {
        const aNum = parseInt(a.מספר_בן) || 999;
        const bNum = parseInt(b.מספר_בן) || 999;
        return aNum - bNum;
    }) : [];

    return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;" dir="rtl">
            
            <!-- שלום משתמש -->
            <div style="position: fixed; top: 20px; right: 20px; background: rgba(76, 175, 80, 0.9); color: white; padding: 12px 20px; border-radius: 25px; font-weight: bold; z-index: 1000;">
                👋 שלום ${currentUserName}
            </div>

            <!-- קונטיינר ראשי -->
            <div style="max-width: 1200px; margin: 80px auto 0; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden;">
                
                <!-- כותרת המשפחה -->
                <div style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 30px; text-align: center; position: relative;">
    
    <!-- לחצנים מרחפים על השטח הירוק -->
    <div style="position: absolute; top: 15px; left: 15px; display: flex; gap: 10px; z-index: 100;">
        <button onclick="logoutUser()" style="background: #f44336; color: white; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px;">
            🚪 יציאה
        </button>
        
        <button id="returnButton" onclick="returnToParentFamily()" style="background: #2196F3; color: white; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px; transition: all 0.3s ease;"
                onmouseover="this.style.background='#1976D2'; this.style.transform='scale(1.05)';"
                onmouseout="this.style.background='#2196F3'; this.style.transform='scale(1)';">
            ⬅️ חזור למשפחה המורחבת
        </button>
    </div>
                    <h1 style="margin: 0; font-size: 2.5em;">👨‍👩‍👧‍👦 משפחת ${family.lastName || 'לא מוגדר'}</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.2em;">משפחה מספר ${family.familyNumber}</p>
                    ${family.city ? `<p style="margin: 5px 0 0 0;">🏙️ ${family.city}</p>` : ''}
                </div>

                <!-- תוכן המשפחה -->
                <div style="padding: 30px;">
                    
                    <!-- ההורים -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <!-- האב -->
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 25px; border-radius: 12px; border: 2px solid #2196F3;">
                            <h3 style="margin-top: 0; color: #1565c0; text-align: center;">👨 הבעל</h3>
                            ${family.father ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">${family.father.שם_פרטי} ${family.father.שם_משפחה}</div>
                                    <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                        <div>🆔 מספר אישי: ${family.father.מספר_אישי}</div>
                                        ${family.father.תאריך_לידה ? `<div>🎂 תאריך לידה: ${family.father.תאריך_לידה}</div>` : ''}
                                        ${family.father.שם_אם ? `<div>👩 שם האם: ${family.father.שם_אם}</div>` : ''}
                                        ${family.father.עיר_מגורים ? `<div>🏠 עיר מגורים: ${family.father.עיר_מגורים}</div>` : ''}
                                    </div>
                                </div>
                            ` : '<div style="text-align: center; color: #999;">אין נתוני בעל</div>'}
                        </div>

                        <!-- האישה -->
                        <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 25px; border-radius: 12px; border: 2px solid #e91e63;">
                            <h3 style="margin-top: 0; color: #c2185b; text-align: center;">👩 האישה</h3>
                            ${family.mother ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">${family.mother.שם_פרטי} ${family.mother.שם_משפחה}</div>
                                    <div style="font-size: 0.9em; color: #666; line-height: 1.5;">
                                        <div>🆔 מספר אישי: ${family.mother.מספר_אישי}</div>
                                        ${family.mother.תאריך_לידה ? `<div>🎂 תאריך לידה: ${family.mother.תאריך_לידה}</div>` : ''}
                                        ${family.mother.שם_אם ? `<div>👩 שם האם: ${family.mother.שם_אם}</div>` : ''}
                                        ${family.mother.תאריך_נשואין ? `<div>💒 תאריך חתונה: ${family.mother.תאריך_נשואין}</div>` : ''}
                                    </div>
                                </div>
                            ` : '<div style="text-align: center; color: #999;">אין נתוני אישה</div>'}
                        </div>
                    </div>

                    <!-- ילדים רווקים -->
                    ${singleChildren.length > 0 ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #ff6f00; margin-bottom: 15px; text-align: center; font-size: 1.5em;">
                                👶 ילדים רווקים (${singleChildren.length}) - לפי סדר הלידה
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                ${singleChildren.map(child => createChildCard(child, 'single')).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- ילדים נשואים -->
                    ${marriedChildren.length > 0 ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #2e7d32; margin-bottom: 15px; text-align: center; font-size: 1.5em;">
                                💒 ילדים נשואים (${marriedChildren.length}) - לפי סדר הלידה
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                ${marriedChildren.map(child => createChildCard(child, 'married')).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- אין ילדים -->
                    ${singleChildren.length === 0 && marriedChildren.length === 0 ? `
                        <div style="text-align: center; color: #666; padding: 40px; font-style: italic;">
                            <div style="font-size: 3em; margin-bottom: 20px;">👶</div>
                            <div>אין ילדים רשומים במשפחה זו</div>
                        </div>
                    ` : ''}

                </div>
            </div>
        </div>
    `;
}

// ===== יצירת כרטיס ילד =====
function createChildCard(child, type) {
    const childNumber = child.מספר_בן || '';
    const benBat = child.מין === 'זכר' ? 'בן' : 'בת';
    const motherName = child.שם_אם || '';
    const fullChildName = motherName ? `${child.שם_פרטי} ${benBat} ${motherName}` : child.שם_פרטי;
    
    // הפרדה בין רווקים ונשואים לפי הנתונים
    const isMarried = child.נשוי_רווק && !child.נשוי_רווק.includes('רווק') && child.משפ_עצמי && child.משפ_עצמי !== '0';
    const cardType = isMarried ? 'married' : 'single';
    
    // קביעת צבע רקע
    const bgColor = cardType === 'married' ? 
        'linear-gradient(135deg, #f0fff0, #c8e6c8)' : 
        'linear-gradient(135deg, #fff3e0, #ffe0b2)';
    
    const borderColor = cardType === 'married' ? '#4caf50' : '#ff9800';
    
    return `
        <div style="
            background: ${bgColor}; 
            border: 2px solid ${borderColor}; 
            border-radius: 12px; 
            padding: 20px; 
            transition: all 0.3s ease;
            cursor: pointer;
        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 8px;">
                        ${childNumber ? `${childNumber}. ` : ''}${fullChildName}
                        ${cardType === 'married' ? ' 💒' : ' 👶'}
                    </div>
                    <div style="font-size: 0.9em; color: #666; line-height: 1.4;">
                        <div>${child.מין} - מספר ${child.מספר_אישי}</div>
                        ${child.תאריך_לידה ? `<div>🎂 ${child.תאריך_לידה}</div>` : ''}
                        ${cardType === 'married' && child.נשוי_רווק ? `<div>💒 ${child.נשוי_רווק}</div>` : ''}
                        ${cardType === 'married' && child.משפ_עצמי ? `<div>🏠 משפחה מספר ${child.משפ_עצמי}</div>` : ''}
                        ${child.הערה ? `<div>📝 ${child.הערה}</div>` : ''}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    ${cardType === 'married' && child.משפ_עצמי && child.משפ_עצמי !== '0' ? `
                        <button onclick="viewChildFamily('${child.מספר_אישי}', '${child.שם_פרטי}', '${child.משפ_עצמי}')" 
                                style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#1976D2'; this.style.transform='scale(1.05)';"
                                onmouseout="this.style.background='#2196F3'; this.style.transform='scale(1)';">
                            🏠 צפה במשפחה
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}
let parentFamilyStack = [];

// צפייה במשפחת ילד נשוי
function viewChildFamily(childPersonalNumber, childName, childFamilyNumber) {
    console.log('viewChildFamily נקראה:', {childPersonalNumber, childName, childFamilyNumber});
    
    // אם זה הפעם הראשונה שנכנסים למשפחת ילד, שמור את המשפחה המקורית
    if (parentFamilyStack.length === 0) {
        parentFamilyStack.push(currentUser.familyNumber);
        console.log('שמירת משפחה מקורית במחסנית:', currentUser.familyNumber);
    }
    
    // הצג את לחצן החזרה
    const returnButton = document.getElementById('returnButton');
    if (returnButton) {
        returnButton.style.display = 'block';
    }
    
    console.log('טוען משפחת ילד:', childFamilyNumber);
    
    // טען את משפחת הילד
    loadUserFamilyFromSheets(null, childFamilyNumber);
}

// עדכון פונקציית הטעינה לקבל מספר משפחה
async function loadUserFamilyFromSheets(userEmail, specificFamilyNumber = null) {
    try {
        // קבלת מספר המשפחה
        const familyNumber = specificFamilyNumber || currentUser.familyNumber;
        
        console.log('מספר משפחה שנמצא:', familyNumber);
        
        if (!familyNumber) {
            showMessage('warning', 'לא נמצא מספר משפחה עבורך. פנה למנהל המערכת.', 'loginMessage');
            return;
        }
        
        console.log('קורא נתונים מגליון כוללות_צעטיל...');
        
        const familyData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
        
        console.log('נתונים שהתקבלו:', familyData?.length, 'שורות');
        
        const processedFamilyData = organizeFamilyDataFromSheets(familyData, familyNumber);
        
        console.log('נתוני משפחה מעובדים:', processedFamilyData);
        
        if (processedFamilyData) {
            displayUserFamily(processedFamilyData, specificFamilyNumber !== null);
        } else {
            showMessage('error', 'לא נמצאו נתוני משפחה מספר: ' + familyNumber, 'loginMessage');
        }
        
    } catch (error) {
        console.error('שגיאה בטעינת המשפחה:', error);
        showMessage('error', 'שגיאה בטעינת המשפחה: ' + error.toString(), 'loginMessage');
    }
}


// חזרה למשפחה עליונה
function returnToParentFamily() {
    console.log('returnToParentFamily נקראה');
    console.log('מחסנית נוכחית:', parentFamilyStack);
    
    if (parentFamilyStack.length === 0) {
        // אין משפחה לחזור אליה - חזור למשפחה המקורית של המשתמש
        console.log('חוזר למשפחה המקורית של המשתמש:', currentUser.familyNumber);
        loadUserFamilyFromSheets(null, currentUser.familyNumber);
        return;
    }
    
    // חזור למשפחה המקורית (תמיד הראשונה במחסנית)
    const originalFamilyNumber = parentFamilyStack[0];
    
    // נקה את המחסנית
    parentFamilyStack = [];
    
    console.log('חוזר למשפחה המקורית:', originalFamilyNumber);
    
    // הסתר את לחצן החזרה
    const returnButton = document.getElementById('returnButton');
    if (returnButton) {
        returnButton.style.display = 'none';
    }
    
    // טען את המשפחה המקורית
    loadUserFamilyFromSheets(null, originalFamilyNumber);
}

// ===== יצירת תוכן משפחה (לשימוש חוזר) =====
function createFamilyContentHTML(family) {
    const singleChildren = family.children ? family.children.filter(child => 
        !child['נשוי/רווק'] || child['נשוי/רווק'].includes('רווק')
    ).sort((a, b) => {
        const aNum = parseInt(a.מספר_בן) || 999;
        const bNum = parseInt(b.מספר_בן) || 999;
        return aNum - bNum;
    }) : [];

    const marriedChildren = family.children ? family.children.filter(child => 
        child['נשוי/רווק'] && !child['נשוי/רווק'].includes('רווק')
    ).sort((a, b) => {
        const aNum = parseInt(a.מספר_בן) || 999;
        const bNum = parseInt(b.מספר_בן) || 999;
        return aNum - bNum;
    }) : [];

    return `
        <!-- ההורים -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- האב -->
            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 12px; border: 2px solid #2196F3;">
                <h3 style="margin-top: 0; color: #1565c0; text-align: center;">👨 הבעל</h3>
                ${family.father ? `
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">${family.father.שם_פרטי} ${family.father.שם_משפחה}</div>
                        <div style="font-size: 0.85em; color: #666; line-height: 1.4;">
                            <div>🆔 ${family.father.מספר_אישי}</div>
                            ${family.father.תאריך_לידה ? `<div>🎂 ${family.father.תאריך_לידה}</div>` : ''}
                            ${family.father.שם_אם ? `<div>👩 ${family.father.שם_אם}</div>` : ''}
                        </div>
                    </div>
                ` : '<div style="text-align: center; color: #999;">אין נתוני בעל</div>'}
            </div>

            <!-- האישה -->
            <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); padding: 20px; border-radius: 12px; border: 2px solid #e91e63;">
                <h3 style="margin-top: 0; color: #c2185b; text-align: center;">👩 האישה</h3>
                ${family.mother ? `
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">${family.mother.שם_פרטי} ${family.mother.שם_משפחה}</div>
                        <div style="font-size: 0.85em; color: #666; line-height: 1.4;">
                            <div>🆔 ${family.mother.מספר_אישי}</div>
                            ${family.mother.תאריך_לידה ? `<div>🎂 ${family.mother.תאריך_לידה}</div>` : ''}
                            ${family.mother.שם_אם ? `<div>👩 ${family.mother.שם_אם}</div>` : ''}
                            ${family.mother.תאריך_נשואין ? `<div>💒 ${family.mother.תאריך_נשואין}</div>` : ''}
                        </div>
                    </div>
                ` : '<div style="text-align: center; color: #999;">אין נתוני אישה</div>'}
            </div>
        </div>

        <!-- ילדים רווקים -->
        ${singleChildren.length > 0 ? `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #ff6f00; margin-bottom: 15px; text-align: center;">👶 ילדים רווקים (${singleChildren.length})</h3>
                <div style="display: grid; gap: 10px;">
                    ${singleChildren.map(child => createSimpleChildCard(child, 'single')).join('')}
                </div>
            </div>
        ` : ''}

        <!-- ילדים נשואים -->
        ${marriedChildren.length > 0 ? `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #2e7d32; margin-bottom: 15px; text-align: center;">💒 ילדים נשואים (${marriedChildren.length})</h3>
                <div style="display: grid; gap: 10px;">
                    ${marriedChildren.map(child => createSimpleChildCard(child, 'married')).join('')}
                </div>
            </div>
        ` : ''}

        ${singleChildren.length === 0 && marriedChildren.length === 0 ? `
            <div style="text-align: center; color: #666; padding: 20px; font-style: italic;">אין ילדים רשומים</div>
        ` : ''}
    `;
}

// ===== יציאה מהמערכת =====
function logoutUser() {
    if (confirm('האם אתה בטוח שברצונך לצאת מהמערכת?')) {
        // הסרת תצוגת המשפחה
        const familyContainer = document.getElementById('familyViewContainer');
        if (familyContainer) {
            familyContainer.remove();
        }
        
        // הצגת טופס ההתחברות מחדש
        document.getElementById('loginContainer').style.display = 'block';
        
        // ניקוי משתנים
        currentUserEmail = '';
        currentUserName = '';
        currentFamilyNumber = null;
        
        showMessage('info', 'יצאת מהמערכת בהצלחה', 'loginMessage');
    }
}

// ===== משתנים גלובליים =====
let currentUserEmail = '';
let currentUserName = '';
let currentFamilyNumber = null;
    </script>
</body>
</html>
