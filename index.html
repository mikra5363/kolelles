<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כוללות צעטיל - אתר המשפחות</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        /* טפסי הרשמה וכניסה */
        .auth-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 25px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .form-toggle button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .form-toggle button.active {
            background: #4CAF50;
            color: white;
        }

        .auth-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        /* ממשק המשפחה */
        .family-dashboard {
            display: none;
        }

        .user-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info h2 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .family-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .family-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .family-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .family-number {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .parents-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .parent-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .parent-card.father {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .parent-card.mother {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        }

        .parent-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .parent-details {
            font-size: 14px;
            color: #666;
        }

        .children-section {
            margin-top: 20px;
        }

        .children-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .children-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .add-child-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .children-list {
            display: grid;
            gap: 10px;
        }

        .child-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
        }

        .child-item.pending {
            background: #fff8e1;
            border-color: #ffa000;
            opacity: 0.7;
        }

        .child-item.approved {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .child-info {
            flex: 1;
        }

        .child-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .child-details {
            font-size: 12px;
            color: #666;
        }

        .child-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        /* מודל הוספת ילד */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* הודעות */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* טעינה */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* רספונסיב */
        @media (max-width: 768px) {
            .parents-section {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .children-header {
                flex-direction: column;
                gap: 10px;
            }

            .child-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* סטטוס חיבור */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.loading {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status loading">🔄 מתחבר...</div>

    <div class="container">
        <div class="header">
            <h1>🏠 כוללות צעטיל</h1>
            <p>אתר המשפחות הרשמי - צפיה במשפחה והוספת ילדים</p>
        </div>

        <div class="content">
            <!-- מסך הרשמה וכניסה -->
            <div id="authSection" class="auth-container">
                <!-- כפתורי החלפה -->
                <div class="form-toggle">
                    <button id="loginTab" class="active" onclick="showLoginForm()">כניסה</button>
                    <button id="registerTab" onclick="showRegisterForm()">הרשמה</button>
                </div>

                <!-- טופס כניסה -->
                <div id="loginForm" class="auth-form">
                    <h2 style="text-align: center; margin-bottom: 20px;">🔐 כניסה למערכת</h2>
                    
                    <div class="form-group">
                        <label>מספר תעודת זהות</label>
                        <input type="text" id="loginId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>מספר טלפון</label>
                        <input type="tel" id="loginPhone" placeholder="050-1234567" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="loginUser()">
                        🚪 כניסה למערכת
                    </button>

                    <div id="loginMessage"></div>
                </div>

                <!-- טופס הרשמה -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2 style="text-align: center; margin-bottom: 20px;">📝 הרשמה חדשה</h2>
                    
                    <div class="form-group">
                        <label>שם פרטי *</label>
                        <input type="text" id="regFirstName" required>
                    </div>

                    <div class="form-group">
                        <label>שם משפחה *</label>
                        <input type="text" id="regLastName" required>
                    </div>

                    <div class="form-group">
                        <label>שם האב *</label>
                        <input type="text" id="regFatherName" required>
                    </div>

                    <div class="form-group">
                        <label>שם האם *</label>
                        <input type="text" id="regMotherName" required>
                    </div>

                    <div class="form-group">
                        <label>מספר תעודת זהות *</label>
                        <input type="text" id="regId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>מספר טלפון *</label>
                        <input type="tel" id="regPhone" placeholder="050-1234567" required>
                    </div>

                    <div class="form-group">
                        <label>כתובת מייל *</label>
                        <input type="email" id="regEmail" placeholder="example@email.com" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="registerUser()">
                        📧 שלח בקשת הרשמה
                    </button>

                    <div id="registerMessage"></div>

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                        <strong>📋 תהליך ההרשמה:</strong><br>
                        1. מלא את הפרטים ושלח בקשה<br>
                        2. תקבל מייל לאימות הכתובת<br>
                        3. המערכת תבדוק את הנתונים<br>
                        4. לאחר אישור תוכל להתחבר עם ת.ז. וטלפון
                    </div>
                </div>
            </div>

            <!-- מסך המשפחה -->
            <div id="familyDashboard" class="family-dashboard">
                <button class="logout-btn" onclick="logout()">🚪 יציאה</button>

                <div id="userInfo" class="user-info">
                    <!-- מידע המשתמש יטען כאן -->
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>טוען נתוני המשפחה...</p>
                </div>

                <div id="familyContent">
                    <!-- תוכן המשפחה יטען כאן -->
                </div>
            </div>
        </div>
    </div>

    <!-- מודל הוספת ילד -->
    <div id="addChildModal" class="modal-overlay">
        <div class="modal-content">
            <h2>👶 הוספת ילד חדש</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>שם פרטי *</label>
                    <input type="text" id="childFirstName" required>
                </div>

                <div class="form-group">
                    <label>מין *</label>
                    <select id="childGender" required>
                        <option value="">בחר מין</option>
                        <option value="זכר">זכר</option>
                        <option value="נקבה">נקבה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>תאריך לידה עברי</label>
                    <input type="text" id="childBirthDate" placeholder="כ״ג אלול תשפ״ד">
                </div>

                <div class="form-group">
                    <label>שם האם</label>
                    <input type="text" id="childMotherName">
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>הערות</label>
                <textarea id="childNotes" rows="3" placeholder="הערות נוספות..."></textarea>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                <strong>⚠️ שים לב:</strong> הילד יתווסף למערכת אך יהיה במצב "ממתין לאישור" עד שהמנהל יאשר את הוספתו.
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveChild()">
                    💾 הוסף ילד
                </button>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 10px;">
                    ❌ ביטול
                </button>
            </div>

            <div id="childMessage"></div>
        </div>
    </div>

    <script>
        // ===== הגדרות חיבור לגוגל שיטס =====
        
        // 🔧 החלף את הערכים האלה בערכים שלך
        const GOOGLE_SHEETS_CONFIG = {
            API_KEY: 'AIzaSyADMdfuBJtqpzH2h5CVr9FxkBn2Eb5oigc',
            SPREADSHEET_ID: '1dLTsow7grSW3S8ggtRsmPrL-Huir_C-Bhw97gul2yog', // מזהה הגיליון
            RANGES: {
                MEMBERS: 'כוללות_צעטיל!A:AD', // טווח נתוני החברים
                REGISTRATIONS: 'נתוני_החברים!A:E', // טווח הרשמות חדשות
                PENDING_CHILDREN: 'ילדים_ממתינים!A:J' // טווח ילדים ממתינים לאישור
            }
        };

        // ===== משתנים גלובליים =====
        let currentUser = null;
        let allMembers = [];
        let userFamily = null;
        let isConnected = false;

        // ===== אתחול =====
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('loading');
            initializeApp();
        });

        async function initializeApp() {
    try {
        updateConnectionStatus('loading');
        
        // בדיקת חיבור לגוגל שיטס
        console.log('🔄 בודק חיבור לגוגל שיטס...');
        await testGoogleSheetsConnection();
        
        // בדיקת חיבור לגוגל אפס סקריפט
        console.log('🔄 בודק חיבור לגוגל אפס סקריפט...');
        const scriptWorking = await testGoogleAppsScript();
        
        if (scriptWorking) {
            console.log('✅ כל המערכות עובדות');
            updateConnectionStatus('connected');
        } else {
            console.warn('⚠️ יש בעיה עם Google Apps Script');
            updateConnectionStatus('disconnected');
            showMessage('warning', 'יש בעיה בחיבור לשרת. פונקציות הכתיבה עלולות לא לעבוד.', 'loginMessage');
        }
        
        isConnected = true;

        // בדיקה אם יש משתמש מחובר
        const savedUser = localStorage.getItem('familyUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            await loadUserDashboard();
        }
        
    } catch (error) {
        console.error('❌ שגיאה באתחול:', error);
        updateConnectionStatus('disconnected');
        showMessage('error', 'אין חיבור לשרת. נסה לרענן את הדף.', 'loginMessage');
    }
}
async function quickTest() {
    console.log('🧪 מתחיל בדיקה מהירה...');
    
    try {
        // בדיקה 1: חיבור לגוגל שיטס
        console.log('1️⃣ בודק Google Sheets API...');
        await testGoogleSheetsConnection();
        console.log('✅ Google Sheets API עובד');
        
        // בדיקה 2: חיבור לגוגל אפס סקריפט
        console.log('2️⃣ בודק Google Apps Script...');
        await testGoogleAppsScript();
        console.log('✅ Google Apps Script עובד');
        
        // בדיקה 3: נסיון כתיבה לדוגמה
        console.log('3️⃣ בודק כתיבה לגיליון...');
        await writeToGoogleSheets('Test!A1:B1', [['Test', new Date().toISOString()]]);
        console.log('✅ כתיבה לגיליון עובדת');
        
        alert('🎉 כל הבדיקות עברו בהצלחה! המערכת מוכנה לעבודה.');
        
    } catch (error) {
        console.error('❌ בדיקה נכשלה:', error);
        alert(`❌ יש בעיה במערכת: ${error.message}`);
    }
}
        // ===== חיבור לגוגל שיטס =====
        async function testGoogleSheetsConnection() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        async function readFromGoogleSheets(range) {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${range}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('שגיאה בקריאה מהגיליון:', error);
                throw error;
            }
        }

        
// הגדרת URL של Google Apps Script
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8kJdoUvL7tKNlHOYfpxpRntDQqpY4q27jc8v95N4pSdqM9dJ5n53F_fEN7QIeoQ/exec';

async function writeToGoogleSheets(range, values) {
    try {
        console.log('שולח נתונים ל-Google Sheets:', { range, values });
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // חשוב למניעת שגיאות CORS
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'write',
                range: range,
                values: values
            })
        });

        // בגלל no-cors לא נוכל לבדוק את התגובה
        // אבל אם לא היתה שגיאת רשת, נניח שהכל עבר בסדר
        console.log('✅ נתונים נשלחו בהצלחה ל-Google Sheets');
        return { success: true };

    } catch (error) {
        console.error('❌ שגיאה בכתיבה ל-Google Sheets:', error);
        
        // זיהוי סוג השגיאה
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            throw new Error('אין חיבור לאינטרנט או שהשרת לא זמין');
        }
        
        throw new Error(`שגיאה בשליחת הנתונים: ${error.message}`);
    }
}


        // ===== ממשק משתמש =====
        function showLoginForm() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegisterForm() {
    document.getElementById('loginTab').classList.remove('active');
    document.getElementById('registerTab').classList.add('active');
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = '✅ מחובר';
                    break;
                case 'disconnected':
                    statusElement.textContent = '❌ לא מחובר';
                    break;
                case 'loading':
                    statusElement.textContent = '🔄 מתחבר...';
                    break;
            }
        }

        // ===== הרשמה =====
    async function registerUser() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const fatherName = document.getElementById('regFatherName').value.trim();
    const motherName = document.getElementById('regMotherName').value.trim();
    const idNumber = document.getElementById('regId').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const email = document.getElementById('regEmail').value.trim();

    // וידוא שדות
    if (!firstName || !lastName || !fatherName || !motherName || !idNumber || !phone || !email) {
        showMessage('error', 'יש למלא את כל השדות החובה', 'registerMessage');
        return;
    }

    // וידוא ת.ז.
    if (!/^\d{9}$/.test(idNumber)) {
        showMessage('error', 'מספר תעודת זהות חייב להכיל 9 ספרות', 'registerMessage');
        return;
    }

    // וידוא מייל
    if (!/\S+@\S+\.\S+/.test(email)) {
        showMessage('error', 'כתובת מייל לא תקינה', 'registerMessage');
        return;
    }

    try {
        showMessage('info', '🔄 שולח בקשת הרשמה...', 'registerMessage');

        // בדיקה אם המשתמש כבר קיים
        console.log('🔍 בודק אם המשתמש קיים...');
        const existingRegistrations = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);
        
        const userExists = existingRegistrations.some(row => 
            row[3] === idNumber || row[4] === phone || row[2] === email
        );

        if (userExists) {
            showMessage('error', 'משתמש עם הפרטים האלה כבר קיים במערכת', 'registerMessage');
            return;
        }

        // הכנת הנתונים לשליחה
        const timestamp = new Date().toISOString();
        const fullName = `${firstName} בן/בת ${motherName} ואבי ${fatherName}`;
        
        const newRegistration = [
            firstName,
            lastName, 
            email,
            idNumber,
            phone,
            fullName,
            timestamp,
            'ממתין לאישור',
            'לא אומת'
        ];

        console.log('📤 שולח נתוני הרשמה:', newRegistration);

        // שליחת הנתונים לגיליון
        await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS, [newRegistration]);

        // שליחת מייל אימות
        console.log('📧 שולח מייל אימות...');
        const emailResult = await sendVerificationEmail(email, firstName);
        
        if (!emailResult.success) {
            console.warn('⚠️ מייל לא נשלח, אבל ההרשמה הצליחה');
        }

        // הודעת הצלחה
        showMessage('success', 
            `✅ <strong>בקשת ההרשמה נשלחה בהצלחה!</strong><br><br>
            📧 מייל אימות ${emailResult.success ? 'נשלח' : 'יישלח בהמשך'} לכתובת: ${email}<br>
            🔍 לאחר אימות המייל, הבקשה תועבר לאישור המנהל<br>
            📱 תקבל הודעה כשהחשבון יאושר<br><br>
            <small>זמן שליחה: ${new Date().toLocaleString('he-IL')}</small>`, 
            'registerMessage'
        );

        // ניקוי הטופס
        document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');

        console.log('✅ תהליך ההרשמה הושלם בהצלחה');

    } catch (error) {
        console.error('❌ שגיאה כללית בהרשמה:', error);
        
        // הודעת שגיאה מפורטת
        let errorMessage = 'שגיאה בשליחת ההרשמה.';
        
        if (error.message.includes('אין חיבור')) {
            errorMessage = 'אין חיבור לאינטרנט. בדוק את החיבור ונסה שוב.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'בעיה בחיבור לשרת. נסה שוב בעוד כמה דקות.';
        }
        
        showMessage('error', `❌ ${errorMessage}<br><small>שגיאה טכנית: ${error.message}</small>`, 'registerMessage');
    }
}
    
        // ===== כניסה =====
        async function loginUser() {
            const idNumber = document.getElementById('loginId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();

            if (!idNumber || !phone) {
                showMessage('error', 'יש למלא מספר ת.ז. וטלפון', 'loginMessage');
                return;
            }

            if (!/^\d{9}$/.test(idNumber)) {
                showMessage('error', 'מספר תעודת זהות חייב להכיל 9 ספרות', 'loginMessage');
                return;
            }

            try {
                showMessage('info', 'מתחבר למערכת...', 'loginMessage');

                // בדיקה ברשימת המשתמשים המאושרים
                const approvedUsers = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);
                
                const user = approvedUsers.find(row => 
                    row[3] === idNumber && 
                    row[4] === phone && 
                    row[7] === 'מאושר' && 
                    row[8] === 'אומת'
                );

                if (!user) {
                    showMessage('error', 
                        'פרטי ההתחברות שגויים או שהחשבון עדיין לא אושר.<br>' +
                        'אם נרשמת לאחרונה, המתן לאישור המנהל.', 
                        'loginMessage'
                    );
                    return;
                }

                // שמירת המשתמש
                currentUser = {
                    firstName: user[0],
                    lastName: user[1],
                    email: user[2],
                    idNumber: user[3],
                    phone: user[4],
                    fullName: user[5]
                };

                localStorage.setItem('familyUser', JSON.stringify(currentUser));

                // מעבר לממשק המשפחה
                await loadUserDashboard();

            } catch (error) {
                console.error('שגיאה בכניסה:', error);
                showMessage('error', 'שגיאה בהתחברות. נסה שוב מאוחר יותר.', 'loginMessage');
            }
        }

        // ===== ממשק המשפחה =====
        async function loadUserDashboard() {
            try {
                // הסתרת מסך ההתחברות
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('familyDashboard').style.display = 'block';
                document.getElementById('loading').style.display = 'block';

                // עדכון מידע המשתמש
                document.getElementById('userInfo').innerHTML = `
                    <h2>שלום ${currentUser.firstName} ${currentUser.lastName}</h2>
                    <p>📧 ${currentUser.email} | 📱 ${currentUser.phone}</p>
                    <p>${currentUser.fullName}</p>
                `;

                // טעינת נתוני החברים
                await loadMembersData();

                // מציאת המשפחה של המשתמש
                await findUserFamily();

                // הצגת המשפחה
                displayUserFamily();

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('שגיאה בטעינת הממשק:', error);
                showMessage('error', 'שגיאה בטעינת נתוני המשפחה', 'familyContent');
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadMembersData() {
            const membersData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
            
            // המרת הנתונים למבנה אובייקט
            if (membersData.length > 1) {
                const headers = membersData[0];
                allMembers = membersData.slice(1).map(row => {
                    const member = {};
                    headers.forEach((header, index) => {
                        member[header] = row[index] || '';
                    });
                    return member;
                });
            }
        }

        async function findUserFamily() {
            // חיפוש המשתמש ברשימת החברים
            const userMember = allMembers.find(member => 
                member.מספר_אישי && (
                    // חיפוש לפי שם מלא משוער
                    (member.שם_פרטי === currentUser.firstName && member.שם_משפחה === currentUser.lastName) ||
                    // או חיפוש לפי הערות שמכילות ת.ז.
                    (member.הערה && member.הערה.includes(currentUser.idNumber))
                )
            );

            if (userMember) {
                // אם נמצא המשתמש, מציאת המשפחה שלו
                const familyNumber = userMember.משפ_עצמי || userMember.משפ_הורים;
                
                if (familyNumber) {
                    userFamily = await buildFamilyStructure(familyNumber);
                }
            }

            // אם לא נמצאה משפחה, חיפוש לפי שם
            if (!userFamily) {
                userFamily = await searchFamilyByName();
            }
        }

        async function buildFamilyStructure(familyNumber) {
            const father = allMembers.find(m => 
                parseInt(m.משפ_עצמי) === parseInt(familyNumber) && m.ראש_משפחה === 'TRUE'
            );

            const mother = allMembers.find(m => 
                parseInt(m.מספר_הזוג) === parseInt(father?.מספר_אישי)
            );

            const children = allMembers.filter(m => 
                parseInt(m.משפ_הורים) === parseInt(familyNumber)
            ).sort((a, b) => {
                const aNum = parseInt(a.מספר_בן) || 999;
                const bNum = parseInt(b.מספר_בן) || 999;
                return aNum - bNum;
            });

            return {
                familyNumber: familyNumber,
                father: father,
                mother: mother,
                children: children,
                lastName: father?.שם_משפחה || mother?.שם_משפחה,
                marriageDate: father?.תאריך_נשואין
            };
        }

        async function searchFamilyByName() {
            // חיפוש משפחה לפי שם המשתמש
            const possibleFathers = allMembers.filter(m => 
                m.שם_פרטי === currentUser.firstName && 
                m.שם_משפחה === currentUser.lastName &&
                m.ראש_משפחה === 'TRUE'
            );

            if (possibleFathers.length > 0) {
                return await buildFamilyStructure(possibleFathers[0].משפ_עצמי);
            }

            // חיפוש כילד במשפחה
            const possibleChildren = allMembers.filter(m => 
                m.שם_פרטי === currentUser.firstName && 
                m.משפ_הורים
            );

            if (possibleChildren.length > 0) {
                return await buildFamilyStructure(possibleChildren[0].משפ_הורים);
            }

            return null;
        }

        function displayUserFamily() {
            const familyContent = document.getElementById('familyContent');

            if (!userFamily) {
                familyContent.innerHTML = `
                    <div class="message warning">
                        <h3>⚠️ משפחה לא נמצאה</h3>
                        <p>לא הצלחנו למצוא את המשפחה שלך במערכת.</p>
                        <p>אנא פנה למנהל המערכת לבירור.</p>
                        <p><strong>פרטיך:</strong> ${currentUser.firstName} ${currentUser.lastName}</p>
                    </div>
                `;
                return;
            }

            familyContent.innerHTML = `
                <div class="family-card">
                    <div class="family-header">
                        <div class="family-title">משפחת ${userFamily.lastName}</div>
                        <div class="family-number">משפחה ${userFamily.familyNumber}</div>
                    </div>

                    <div class="parents-section">
                        <div class="parent-card father">
                            <div class="parent-name">👨 ${userFamily.father ? userFamily.father.שם_פרטי : 'לא מוגדר'}</div>
                            <div class="parent-details">
                                ${userFamily.father ? `
                                    מספר: ${userFamily.father.מספר_אישי}<br>
                                    ${userFamily.father.תאריך_לידה ? `נולד: ${userFamily.father.תאריך_לידה}<br>` : ''}
                                    ${userFamily.father.שם_אם ? `בן ${userFamily.father.שם_אם}` : ''}
                                ` : 'אין מידע'}
                            </div>
                        </div>

                        <div class="parent-card mother">
                            <div class="parent-name">👩 ${userFamily.mother ? userFamily.mother.שם_פרטי : 'לא מוגדר'}</div>
                            <div class="parent-details">
                                ${userFamily.mother ? `
                                    מספר: ${userFamily.mother.מספר_אישי}<br>
                                    ${userFamily.mother.תאריך_לידה ? `נולדה: ${userFamily.mother.תאריך_לידה}<br>` : ''}
                                    ${userFamily.mother.שם_אם ? `בת ${userFamily.mother.שם_אם}` : ''}
                                ` : 'אין מידע'}
                            </div>
                        </div>
                    </div>

                    ${userFamily.marriageDate ? `
                        <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                            💒 <strong>תאריך חתונה:</strong> ${userFamily.marriageDate}
                        </div>
                    ` : ''}

                    <div class="children-section">
                        <div class="children-header">
                            <div class="children-title">👶 הילדים (${userFamily.children.length})</div>
                            <button class="add-child-btn" onclick="openAddChildModal()">
                                ➕ הוסף ילד
                            </button>
                        </div>
                        
<button onclick="quickTest()" style="position: fixed; top: 60px; right: 20px; background: #2196F3; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; z-index: 1000;">
    🧪 בדיקה מהירה
</button>
                        <div class="children-list">
                            ${userFamily.children.length > 0 ? 
                                userFamily.children.map(child => createChildCard(child)).join('') :
                                '<div style="text-align: center; color: #666; padding: 20px;">אין ילדים רשומים</div>'
                            }
                        </div>
                    </div>
                </div>

                <span class="text-xs" id="formError"></span>
            `;
        }

        function createChildCard(child) {
            const benBat = child.מין === 'זכר' ? 'בן' : 'בת';
            const motherName = child.שם_אם || userFamily.mother?.שם_פרטי || '';
            const fullChildName = motherName ? `${child.שם_פרטי} ${benBat} ${motherName}` : child.שם_פרטי;
            
            const isApproved = child.מאושר !== 'ממתין לאישור';
            
            return `
                <div class="child-item ${isApproved ? 'approved' : 'pending'}">
                    <div class="child-info">
                        <div class="child-name">
                            ${child.מספר_בן ? `${child.מספר_בן}. ` : ''}${fullChildName}
                        </div>
                        <div class="child-details">
                            ${child.מין} • מספר ${child.מספר_אישי}
                            ${child.תאריך_לידה ? ` • ${child.תאריך_לידה}` : ''}
                            ${child.הערה ? ` • ${child.הערה}` : ''}
                        </div>
                    </div>
                    <div class="child-status ${isApproved ? 'status-approved' : 'status-pending'}">
                        ${isApproved ? '✅ מאושר' : '⏳ ממתין לאישור'}
                    </div>
                </div>
            `;
        }

        async function loadPendingChildren() {
            try {
                const pendingData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.PENDING_CHILDREN);
                
                const userPendingChildren = pendingData.filter(row => 
                    parseInt(row[6]) === parseInt(userFamily.familyNumber) // עמודת מספר משפחה
                );

                if (userPendingChildren.length === 0) {
                    return '';
                }

                return `
                    <div class="family-card" style="margin-top: 20px; border-color: #ff9800;">
                        <div class="family-header">
                            <div class="family-title" style="color: #ff6f00;">ילדים ממתינים לאישור</div>
                        </div>

                        <div class="children-list">
                            ${userPendingChildren.map(child => `
                                <div class="child-item pending">
                                    <div class="child-info">
                                        <div class="child-name">${child[0]} ${child[1]}</div>
                                        <div class="child-details">
                                            ${child[2]} • ${child[3] || 'לא מוגדר תאריך לידה'}
                                            ${child[4] ? ` • ${child[4]}` : ''}
                                        </div>
                                    </div>
                                    <div class="child-status status-pending">
                                        ⏳ ממתין לאישור
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('שגיאה בטעינת ילדים ממתינים:', error);
                return '';
            }
        }

        // ===== הוספת ילד =====
        function openAddChildModal() {
            document.getElementById('addChildModal').style.display = 'flex';
            
            // מילוי אוטומטי של שם האם
            const motherName = userFamily.mother?.שם_פרטי || '';
            document.getElementById('childMotherName').value = motherName;
        }

        async function saveChild() {
            const firstName = document.getElementById('childFirstName').value.trim();
            const gender = document.getElementById('childGender').value;
            const birthDate = document.getElementById('childBirthDate').value.trim();
            const motherName = document.getElementById('childMotherName').value.trim();
            const notes = document.getElementById('childNotes').value.trim();

            // וידוא שדות חובה
            if (!firstName || !gender) {
                showMessage('error', 'יש למלא שם פרטי ומין', 'childMessage');
                return;
            }

            try {
                showMessage('info', 'שומר ילד...', 'childMessage');

                // חישוב מספר הילד הבא בסדר
                const maxChildNumber = userFamily.children.reduce((max, child) => {
                    const num = parseInt(child.מספר_בן) || 0;
                    return num > max ? num : max;
                }, 0);

                const nextChildNumber = maxChildNumber + 1;

                // הכנת הנתונים
                const childData = [
                    firstName,
                    userFamily.lastName,
                    gender,
                    birthDate,
                    notes,
                    motherName,
                    userFamily.familyNumber,
                    nextChildNumber,
                    new Date().toISOString(),
                    'ממתין לאישור'
                ];

                // שמירה בגיליון ילדים ממתינים
                await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.PENDING_CHILDREN, [childData]);

                showMessage('success', 
                    `הילד ${firstName} נוסף בהצלחה!<br>הוא ממתין כעת לאישור המנהל.`, 
                    'childMessage'
                );

                // ניקוי הטופס
                document.getElementById('childFirstName').value = '';
                document.getElementById('childGender').value = '';
                document.getElementById('childBirthDate').value = '';
                document.getElementById('childNotes').value = '';

                // רענון התצוגה אחרי 2 שניות
                setTimeout(async () => {
                    closeModal();
                    await loadUserDashboard();
                }, 2000);

            } catch (error) {
                console.error('שגיאה בהוספת הילד:', error);
                showMessage('error', 'שגיאה בשמירת הילד. נסה שוב מאוחר יותר.', 'childMessage');
            }
        }

        async function sendVerificationEmail(email, firstName) {
    try {
        console.log(`שולח מייל אימות ל-${email} עבור ${firstName}`);
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'sendEmail',
                email: email,
                firstName: firstName,
                subject: 'אימות כתובת מייל - כוללות צעטיל',
                message: `שלום ${firstName},\n\nתודה על הרשמתך למערכת כוללות צעטיל.\nבקשתך התקבלה ותטופל בהקדם.\n\nבברכה,\nצוות כוללות צעטיל`
            })
        });

        console.log('✅ מייל נשלח בהצלחה');
        return { success: true };
        
    } catch (error) {
        console.error('⚠️ שגיאה בשליחת מייל:', error);
        // אל תעצור את התהליך בגלל שגיאת מייל
        return { success: false, error: error.message };
    }
}

async function testGoogleAppsScript() {
    try {
        console.log('🔄 בודק חיבור ל-Google Apps Script...');
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'GET', // בדיקה פשוטה עם GET
            mode: 'no-cors'
        });
        
        console.log('✅ חיבור ל-Google Apps Script עובד');
        return true;
        
    } catch (error) {
        console.error('❌ בעיה בחיבור ל-Google Apps Script:', error);
        return false;
    }
}
        // ===== פונקציות עזר =====
        function showMessage(type, message, elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // הסרת ההודעה אחרי 10 שניות
            setTimeout(() => {
                element.innerHTML = '';
            }, 10000);
        }

        function closeModal() {
            document.getElementById('addChildModal').style.display = 'none';
            
            // ניקוי הודעות
            document.getElementById('childMessage').innerHTML = '';
        }

        function logout() {
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                localStorage.removeItem('familyUser');
                currentUser = null;
                userFamily = null;
                
                // חזרה למסך התחברות
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('familyDashboard').style.display = 'none';
                
                // ניקוי טפסים
                document.getElementById('loginForm').reset();
                document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');
                
                showLoginForm();
            }
        }

        // ===== האזנה לאירועים =====
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // סגירת מודל עם ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // וידוא מספרים בלבד בת.ז.
        document.getElementById('regId')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });

        document.getElementById('loginId')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
       
    </script>
</body>
</html>
