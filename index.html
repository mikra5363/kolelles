<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ - ××ª×¨ ×”××©×¤×—×•×ª</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        /* ×˜×¤×¡×™ ×”×¨×©××” ×•×›× ×™×¡×” */
        .auth-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 25px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .form-toggle button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .form-toggle button.active {
            background: #4CAF50;
            color: white;
        }

        .auth-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        /* ×××©×§ ×”××©×¤×—×” */
        .family-dashboard {
            display: none;
        }

        .user-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info h2 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .family-card {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .family-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .family-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .family-number {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .parents-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .parent-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .parent-card.father {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .parent-card.mother {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        }

        .parent-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .parent-details {
            font-size: 14px;
            color: #666;
        }

        .children-section {
            margin-top: 20px;
        }

        .children-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .children-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .add-child-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .children-list {
            display: grid;
            gap: 10px;
        }

        .child-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
        }

        .child-item.pending {
            background: #fff8e1;
            border-color: #ffa000;
            opacity: 0.7;
        }

        .child-item.approved {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .child-info {
            flex: 1;
        }

        .child-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .child-details {
            font-size: 12px;
            color: #666;
        }

        .child-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        /* ××•×“×œ ×”×•×¡×¤×ª ×™×œ×“ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* ×”×•×“×¢×•×ª */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ×˜×¢×™× ×” */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ×¨×¡×¤×•× ×¡×™×‘ */
        @media (max-width: 768px) {
            .parents-section {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .children-header {
                flex-direction: column;
                gap: 10px;
            }

            .child-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* ×¡×˜×˜×•×¡ ×—×™×‘×•×¨ */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.loading {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status loading">ğŸ”„ ××ª×—×‘×¨...</div>

    <div class="container">
        <div class="header">
            <h1>ğŸ  ×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ</h1>
            <p>××ª×¨ ×”××©×¤×—×•×ª ×”×¨×©××™ - ×¦×¤×™×” ×‘××©×¤×—×” ×•×”×•×¡×¤×ª ×™×œ×“×™×</p>
        </div>

        <div class="content">
            <!-- ××¡×š ×”×¨×©××” ×•×›× ×™×¡×” -->
            <div id="authSection" class="auth-container">
                <!-- ×›×¤×ª×•×¨×™ ×”×—×œ×¤×” -->
                <div class="form-toggle">
                    <button id="loginTab" class="active" onclick="showLoginForm()">×›× ×™×¡×”</button>
                    <button id="registerTab" onclick="showRegisterForm()">×”×¨×©××”</button>
                </div>

                <!-- ×˜×•×¤×¡ ×›× ×™×¡×” -->
                <div id="loginForm" class="auth-form">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
                    
                    <div class="form-group">
                        <label>××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª</label>
                        <input type="text" id="loginId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                        <input type="tel" id="loginPhone" placeholder="050-1234567" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="loginUser()">
                        ğŸšª ×›× ×™×¡×” ×œ××¢×¨×›×ª
                    </button>

                    <div id="loginMessage"></div>
                </div>

                <!-- ×˜×•×¤×¡ ×”×¨×©××” -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ ×”×¨×©××” ×—×“×©×”</h2>
                    
                    <div class="form-group">
                        <label>×©× ×¤×¨×˜×™ *</label>
                        <input type="text" id="regFirstName" required>
                    </div>

                    <div class="form-group">
                        <label>×©× ××©×¤×—×” *</label>
                        <input type="text" id="regLastName" required>
                    </div>

                    <div class="form-group">
                        <label>×©× ×”××‘ *</label>
                        <input type="text" id="regFatherName" required>
                    </div>

                    <div class="form-group">
                        <label>×©× ×”×× *</label>
                        <input type="text" id="regMotherName" required>
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª *</label>
                        <input type="text" id="regId" placeholder="123456789" maxlength="9" required>
                    </div>

                    <div class="form-group">
                        <label>××¡×¤×¨ ×˜×œ×¤×•×Ÿ *</label>
                        <input type="tel" id="regPhone" placeholder="050-1234567" required>
                    </div>

                    <div class="form-group">
                        <label>×›×ª×•×‘×ª ××™×™×œ *</label>
                        <input type="email" id="regEmail" placeholder="example@email.com" required>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="registerUser()">
                        ğŸ“§ ×©×œ×— ×‘×§×©×ª ×”×¨×©××”
                    </button>

                    <div id="registerMessage"></div>

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                        <strong>ğŸ“‹ ×ª×”×œ×™×š ×”×”×¨×©××”:</strong><br>
                        1. ××œ× ××ª ×”×¤×¨×˜×™× ×•×©×œ×— ×‘×§×©×”<br>
                        2. ×ª×§×‘×œ ××™×™×œ ×œ××™××•×ª ×”×›×ª×•×‘×ª<br>
                        3. ×”××¢×¨×›×ª ×ª×‘×“×•×§ ××ª ×”× ×ª×•× ×™×<br>
                        4. ×œ××—×¨ ××™×©×•×¨ ×ª×•×›×œ ×œ×”×ª×—×‘×¨ ×¢× ×ª.×–. ×•×˜×œ×¤×•×Ÿ
                    </div>
                </div>
            </div>

            <!-- ××¡×š ×”××©×¤×—×” -->
            <div id="familyDashboard" class="family-dashboard">
                <button class="logout-btn" onclick="logout()">ğŸšª ×™×¦×™××”</button>

                <div id="userInfo" class="user-info">
                    <!-- ××™×“×¢ ×”××©×ª××© ×™×˜×¢×Ÿ ×›××Ÿ -->
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ × ×ª×•× ×™ ×”××©×¤×—×”...</p>
                </div>

                <div id="familyContent">
                    <!-- ×ª×•×›×Ÿ ×”××©×¤×—×” ×™×˜×¢×Ÿ ×›××Ÿ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×”×•×¡×¤×ª ×™×œ×“ -->
    <div id="addChildModal" class="modal-overlay">
        <div class="modal-content">
            <h2>ğŸ‘¶ ×”×•×¡×¤×ª ×™×œ×“ ×—×“×©</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>×©× ×¤×¨×˜×™ *</label>
                    <input type="text" id="childFirstName" required>
                </div>

                <div class="form-group">
                    <label>××™×Ÿ *</label>
                    <select id="childGender" required>
                        <option value="">×‘×—×¨ ××™×Ÿ</option>
                        <option value="×–×›×¨">×–×›×¨</option>
                        <option value="× ×§×‘×”">× ×§×‘×”</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>×ª××¨×™×š ×œ×™×“×” ×¢×‘×¨×™</label>
                    <input type="text" id="childBirthDate" placeholder="×›×´×’ ××œ×•×œ ×ª×©×¤×´×“">
                </div>

                <div class="form-group">
                    <label>×©× ×”××</label>
                    <input type="text" id="childMotherName">
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>×”×¢×¨×•×ª</label>
                <textarea id="childNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                <strong>âš ï¸ ×©×™× ×œ×‘:</strong> ×”×™×œ×“ ×™×ª×•×•×¡×£ ×œ××¢×¨×›×ª ××š ×™×”×™×” ×‘××¦×‘ "×××ª×™×Ÿ ×œ××™×©×•×¨" ×¢×“ ×©×”×× ×”×œ ×™××©×¨ ××ª ×”×•×¡×¤×ª×•.
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveChild()">
                    ğŸ’¾ ×”×•×¡×£ ×™×œ×“
                </button>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 10px;">
                    âŒ ×‘×™×˜×•×œ
                </button>
            </div>

            <div id="childMessage"></div>
        </div>
    </div>

    <script>
        // ===== ×”×’×“×¨×•×ª ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡ =====
        
        // ğŸ”§ ×”×—×œ×£ ××ª ×”×¢×¨×›×™× ×”××œ×” ×‘×¢×¨×›×™× ×©×œ×š
        const GOOGLE_SHEETS_CONFIG = {
            API_KEY: 'AIzaSyADMdfuBJtqpzH2h5CVr9FxkBn2Eb5oigc',
            SPREADSHEET_ID: '1dLTsow7grSW3S8ggtRsmPrL-Huir_C-Bhw97gul2yog', // ××–×”×” ×”×’×™×œ×™×•×Ÿ
            RANGES: {
                MEMBERS: '×›×•×œ×œ×•×ª_×¦×¢×˜×™×œ!A:AD', // ×˜×•×•×— × ×ª×•× ×™ ×”×—×‘×¨×™×
                REGISTRATIONS: '× ×ª×•× ×™_×”×—×‘×¨×™×!A:E', // ×˜×•×•×— ×”×¨×©××•×ª ×—×“×©×•×ª
                PENDING_CHILDREN: '×™×œ×“×™×_×××ª×™× ×™×!A:J' // ×˜×•×•×— ×™×œ×“×™× ×××ª×™× ×™× ×œ××™×©×•×¨
            }
        };

        // ===== ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× =====
        let currentUser = null;
        let allMembers = [];
        let userFamily = null;
        let isConnected = false;

        // ===== ××ª×—×•×œ =====
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('loading');
            initializeApp();
        });

        async function initializeApp() {
    try {
        updateConnectionStatus('loading');
        
        // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡
        console.log('ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡...');
        await testGoogleSheetsConnection();
        
        // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×’×•×’×œ ××¤×¡ ×¡×§×¨×™×¤×˜
        console.log('ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×’×•×’×œ ××¤×¡ ×¡×§×¨×™×¤×˜...');
        const scriptWorking = await testGoogleAppsScript();
        
        if (scriptWorking) {
            console.log('âœ… ×›×œ ×”××¢×¨×›×•×ª ×¢×•×‘×“×•×ª');
            updateConnectionStatus('connected');
        } else {
            console.warn('âš ï¸ ×™×© ×‘×¢×™×” ×¢× Google Apps Script');
            updateConnectionStatus('disconnected');
            showMessage('warning', '×™×© ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. ×¤×•× ×§×¦×™×•×ª ×”×›×ª×™×‘×” ×¢×œ×•×œ×•×ª ×œ× ×œ×¢×‘×•×“.', 'loginMessage');
        }
        
        isConnected = true;

        // ×‘×“×™×§×” ×× ×™×© ××©×ª××© ××—×•×‘×¨
        const savedUser = localStorage.getItem('familyUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            await loadUserDashboard();
        }
        
    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘××ª×—×•×œ:', error);
        updateConnectionStatus('disconnected');
        showMessage('error', '××™×Ÿ ×—×™×‘×•×¨ ×œ×©×¨×ª. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.', 'loginMessage');
    }
}
async function quickTest() {
    console.log('ğŸ§ª ××ª×—×™×œ ×‘×“×™×§×” ××”×™×¨×”...');
    
    try {
        // ×‘×“×™×§×” 1: ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡
        console.log('1ï¸âƒ£ ×‘×•×“×§ Google Sheets API...');
        await testGoogleSheetsConnection();
        console.log('âœ… Google Sheets API ×¢×•×‘×“');
        
        // ×‘×“×™×§×” 2: ×—×™×‘×•×¨ ×œ×’×•×’×œ ××¤×¡ ×¡×§×¨×™×¤×˜
        console.log('2ï¸âƒ£ ×‘×•×“×§ Google Apps Script...');
        await testGoogleAppsScript();
        console.log('âœ… Google Apps Script ×¢×•×‘×“');
        
        // ×‘×“×™×§×” 3: × ×¡×™×•×Ÿ ×›×ª×™×‘×” ×œ×“×•×’××”
        console.log('3ï¸âƒ£ ×‘×•×“×§ ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ...');
        await writeToGoogleSheets('Test!A1:B1', [['Test', new Date().toISOString()]]);
        console.log('âœ… ×›×ª×™×‘×” ×œ×’×™×œ×™×•×Ÿ ×¢×•×‘×“×ª');
        
        alert('ğŸ‰ ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”! ×”××¢×¨×›×ª ××•×›× ×” ×œ×¢×‘×•×“×”.');
        
    } catch (error) {
        console.error('âŒ ×‘×“×™×§×” × ×›×©×œ×”:', error);
        alert(`âŒ ×™×© ×‘×¢×™×” ×‘××¢×¨×›×ª: ${error.message}`);
    }
}
        // ===== ×—×™×‘×•×¨ ×œ×’×•×’×œ ×©×™×˜×¡ =====
        async function testGoogleSheetsConnection() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        async function readFromGoogleSheets(range) {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${range}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('×©×’×™××” ×‘×§×¨×™××” ××”×’×™×œ×™×•×Ÿ:', error);
                throw error;
            }
        }

        
// ×”×’×“×¨×ª URL ×©×œ Google Apps Script
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8kJdoUvL7tKNlHOYfpxpRntDQqpY4q27jc8v95N4pSdqM9dJ5n53F_fEN7QIeoQ/exec';

async function writeToGoogleSheets(range, values) {
    try {
        console.log('×©×•×œ×— × ×ª×•× ×™× ×œ-Google Sheets:', { range, values });
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // ×—×©×•×‘ ×œ×× ×™×¢×ª ×©×’×™××•×ª CORS
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'write',
                range: range,
                values: values
            })
        });

        // ×‘×’×œ×œ no-cors ×œ× × ×•×›×œ ×œ×‘×“×•×§ ××ª ×”×ª×’×•×‘×”
        // ××‘×œ ×× ×œ× ×”×™×ª×” ×©×’×™××ª ×¨×©×ª, × × ×™×— ×©×”×›×œ ×¢×‘×¨ ×‘×¡×“×¨
        console.log('âœ… × ×ª×•× ×™× × ×©×œ×—×• ×‘×”×¦×œ×—×” ×œ-Google Sheets');
        return { success: true };

    } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×›×ª×™×‘×” ×œ-Google Sheets:', error);
        
        // ×–×™×”×•×™ ×¡×•×’ ×”×©×’×™××”
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            throw new Error('××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ××• ×©×”×©×¨×ª ×œ× ×–××™×Ÿ');
        }
        
        throw new Error(`×©×’×™××” ×‘×©×œ×™×—×ª ×”× ×ª×•× ×™×: ${error.message}`);
    }
}


        // ===== ×××©×§ ××©×ª××© =====
        function showLoginForm() {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegisterForm() {
    document.getElementById('loginTab').classList.remove('active');
    document.getElementById('registerTab').classList.add('active');
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'âœ… ××—×•×‘×¨';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'âŒ ×œ× ××—×•×‘×¨';
                    break;
                case 'loading':
                    statusElement.textContent = 'ğŸ”„ ××ª×—×‘×¨...';
                    break;
            }
        }

        // ===== ×”×¨×©××” =====
    async function registerUser() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const fatherName = document.getElementById('regFatherName').value.trim();
    const motherName = document.getElementById('regMotherName').value.trim();
    const idNumber = document.getElementById('regId').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const email = document.getElementById('regEmail').value.trim();

    // ×•×™×“×•× ×©×“×•×ª
    if (!firstName || !lastName || !fatherName || !motherName || !idNumber || !phone || !email) {
        showMessage('error', '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”', 'registerMessage');
        return;
    }

    // ×•×™×“×•× ×ª.×–.
    if (!/^\d{9}$/.test(idNumber)) {
        showMessage('error', '××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª ×—×™×™×‘ ×œ×”×›×™×œ 9 ×¡×¤×¨×•×ª', 'registerMessage');
        return;
    }

    // ×•×™×“×•× ××™×™×œ
    if (!/\S+@\S+\.\S+/.test(email)) {
        showMessage('error', '×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”', 'registerMessage');
        return;
    }

    try {
        showMessage('info', 'ğŸ”„ ×©×•×œ×— ×‘×§×©×ª ×”×¨×©××”...', 'registerMessage');

        // ×‘×“×™×§×” ×× ×”××©×ª××© ×›×‘×¨ ×§×™×™×
        console.log('ğŸ” ×‘×•×“×§ ×× ×”××©×ª××© ×§×™×™×...');
        const existingRegistrations = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);
        
        const userExists = existingRegistrations.some(row => 
            row[3] === idNumber || row[4] === phone || row[2] === email
        );

        if (userExists) {
            showMessage('error', '××©×ª××© ×¢× ×”×¤×¨×˜×™× ×”××œ×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'registerMessage');
            return;
        }

        // ×”×›× ×ª ×”× ×ª×•× ×™× ×œ×©×œ×™×—×”
        const timestamp = new Date().toISOString();
        const fullName = `${firstName} ×‘×Ÿ/×‘×ª ${motherName} ×•××‘×™ ${fatherName}`;
        
        const newRegistration = [
            firstName,
            lastName, 
            email,
            idNumber,
            phone,
            fullName,
            timestamp,
            '×××ª×™×Ÿ ×œ××™×©×•×¨',
            '×œ× ××•××ª'
        ];

        console.log('ğŸ“¤ ×©×•×œ×— × ×ª×•× ×™ ×”×¨×©××”:', newRegistration);

        // ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ×’×™×œ×™×•×Ÿ
        await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS, [newRegistration]);

        // ×©×œ×™×—×ª ××™×™×œ ××™××•×ª
        console.log('ğŸ“§ ×©×•×œ×— ××™×™×œ ××™××•×ª...');
        const emailResult = await sendVerificationEmail(email, firstName);
        
        if (!emailResult.success) {
            console.warn('âš ï¸ ××™×™×œ ×œ× × ×©×œ×—, ××‘×œ ×”×”×¨×©××” ×”×¦×œ×™×—×”');
        }

        // ×”×•×“×¢×ª ×”×¦×œ×—×”
        showMessage('success', 
            `âœ… <strong>×‘×§×©×ª ×”×”×¨×©××” × ×©×œ×—×” ×‘×”×¦×œ×—×”!</strong><br><br>
            ğŸ“§ ××™×™×œ ××™××•×ª ${emailResult.success ? '× ×©×œ×—' : '×™×™×©×œ×— ×‘×”××©×š'} ×œ×›×ª×•×‘×ª: ${email}<br>
            ğŸ” ×œ××—×¨ ××™××•×ª ×”××™×™×œ, ×”×‘×§×©×” ×ª×•×¢×‘×¨ ×œ××™×©×•×¨ ×”×× ×”×œ<br>
            ğŸ“± ×ª×§×‘×œ ×”×•×“×¢×” ×›×©×”×—×©×‘×•×Ÿ ×™××•×©×¨<br><br>
            <small>×–××Ÿ ×©×œ×™×—×”: ${new Date().toLocaleString('he-IL')}</small>`, 
            'registerMessage'
        );

        // × ×™×§×•×™ ×”×˜×•×¤×¡
        document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');

        console.log('âœ… ×ª×”×œ×™×š ×”×”×¨×©××” ×”×•×©×œ× ×‘×”×¦×œ×—×”');

    } catch (error) {
        console.error('âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘×”×¨×©××”:', error);
        
        // ×”×•×“×¢×ª ×©×’×™××” ××¤×•×¨×˜×ª
        let errorMessage = '×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×¨×©××”.';
        
        if (error.message.includes('××™×Ÿ ×—×™×‘×•×¨')) {
            errorMessage = '××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = '×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›××” ×“×§×•×ª.';
        }
        
        showMessage('error', `âŒ ${errorMessage}<br><small>×©×’×™××” ×˜×›× ×™×ª: ${error.message}</small>`, 'registerMessage');
    }
}
    
        // ===== ×›× ×™×¡×” =====
        async function loginUser() {
            const idNumber = document.getElementById('loginId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();

            if (!idNumber || !phone) {
                showMessage('error', '×™×© ×œ××œ× ××¡×¤×¨ ×ª.×–. ×•×˜×œ×¤×•×Ÿ', 'loginMessage');
                return;
            }

            if (!/^\d{9}$/.test(idNumber)) {
                showMessage('error', '××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª ×—×™×™×‘ ×œ×”×›×™×œ 9 ×¡×¤×¨×•×ª', 'loginMessage');
                return;
            }

            try {
                showMessage('info', '××ª×—×‘×¨ ×œ××¢×¨×›×ª...', 'loginMessage');

                // ×‘×“×™×§×” ×‘×¨×©×™××ª ×”××©×ª××©×™× ×”×××•×©×¨×™×
                const approvedUsers = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.REGISTRATIONS);
                
                const user = approvedUsers.find(row => 
                    row[3] === idNumber && 
                    row[4] === phone && 
                    row[7] === '×××•×©×¨' && 
                    row[8] === '××•××ª'
                );

                if (!user) {
                    showMessage('error', 
                        '×¤×¨×˜×™ ×”×”×ª×—×‘×¨×•×ª ×©×’×•×™×™× ××• ×©×”×—×©×‘×•×Ÿ ×¢×“×™×™×Ÿ ×œ× ××•×©×¨.<br>' +
                        '×× × ×¨×©××ª ×œ××—×¨×•× ×”, ×”××ª×Ÿ ×œ××™×©×•×¨ ×”×× ×”×œ.', 
                        'loginMessage'
                    );
                    return;
                }

                // ×©××™×¨×ª ×”××©×ª××©
                currentUser = {
                    firstName: user[0],
                    lastName: user[1],
                    email: user[2],
                    idNumber: user[3],
                    phone: user[4],
                    fullName: user[5]
                };

                localStorage.setItem('familyUser', JSON.stringify(currentUser));

                // ××¢×‘×¨ ×œ×××©×§ ×”××©×¤×—×”
                await loadUserDashboard();

            } catch (error) {
                console.error('×©×’×™××” ×‘×›× ×™×¡×”:', error);
                showMessage('error', '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'loginMessage');
            }
        }

        // ===== ×××©×§ ×”××©×¤×—×” =====
        async function loadUserDashboard() {
            try {
                // ×”×¡×ª×¨×ª ××¡×š ×”×”×ª×—×‘×¨×•×ª
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('familyDashboard').style.display = 'block';
                document.getElementById('loading').style.display = 'block';

                // ×¢×“×›×•×Ÿ ××™×“×¢ ×”××©×ª××©
                document.getElementById('userInfo').innerHTML = `
                    <h2>×©×œ×•× ${currentUser.firstName} ${currentUser.lastName}</h2>
                    <p>ğŸ“§ ${currentUser.email} | ğŸ“± ${currentUser.phone}</p>
                    <p>${currentUser.fullName}</p>
                `;

                // ×˜×¢×™× ×ª × ×ª×•× ×™ ×”×—×‘×¨×™×
                await loadMembersData();

                // ××¦×™××ª ×”××©×¤×—×” ×©×œ ×”××©×ª××©
                await findUserFamily();

                // ×”×¦×’×ª ×”××©×¤×—×”
                displayUserFamily();

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×××©×§:', error);
                showMessage('error', '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××©×¤×—×”', 'familyContent');
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadMembersData() {
            const membersData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.MEMBERS);
            
            // ×”××¨×ª ×”× ×ª×•× ×™× ×œ××‘× ×” ××•×‘×™×™×§×˜
            if (membersData.length > 1) {
                const headers = membersData[0];
                allMembers = membersData.slice(1).map(row => {
                    const member = {};
                    headers.forEach((header, index) => {
                        member[header] = row[index] || '';
                    });
                    return member;
                });
            }
        }

        async function findUserFamily() {
            // ×—×™×¤×•×© ×”××©×ª××© ×‘×¨×©×™××ª ×”×—×‘×¨×™×
            const userMember = allMembers.find(member => 
                member.××¡×¤×¨_××™×©×™ && (
                    // ×—×™×¤×•×© ×œ×¤×™ ×©× ××œ× ××©×•×¢×¨
                    (member.×©×_×¤×¨×˜×™ === currentUser.firstName && member.×©×_××©×¤×—×” === currentUser.lastName) ||
                    // ××• ×—×™×¤×•×© ×œ×¤×™ ×”×¢×¨×•×ª ×©××›×™×œ×•×ª ×ª.×–.
                    (member.×”×¢×¨×” && member.×”×¢×¨×”.includes(currentUser.idNumber))
                )
            );

            if (userMember) {
                // ×× × ××¦× ×”××©×ª××©, ××¦×™××ª ×”××©×¤×—×” ×©×œ×•
                const familyNumber = userMember.××©×¤_×¢×¦××™ || userMember.××©×¤_×”×•×¨×™×;
                
                if (familyNumber) {
                    userFamily = await buildFamilyStructure(familyNumber);
                }
            }

            // ×× ×œ× × ××¦××” ××©×¤×—×”, ×—×™×¤×•×© ×œ×¤×™ ×©×
            if (!userFamily) {
                userFamily = await searchFamilyByName();
            }
        }

        async function buildFamilyStructure(familyNumber) {
            const father = allMembers.find(m => 
                parseInt(m.××©×¤_×¢×¦××™) === parseInt(familyNumber) && m.×¨××©_××©×¤×—×” === 'TRUE'
            );

            const mother = allMembers.find(m => 
                parseInt(m.××¡×¤×¨_×”×–×•×’) === parseInt(father?.××¡×¤×¨_××™×©×™)
            );

            const children = allMembers.filter(m => 
                parseInt(m.××©×¤_×”×•×¨×™×) === parseInt(familyNumber)
            ).sort((a, b) => {
                const aNum = parseInt(a.××¡×¤×¨_×‘×Ÿ) || 999;
                const bNum = parseInt(b.××¡×¤×¨_×‘×Ÿ) || 999;
                return aNum - bNum;
            });

            return {
                familyNumber: familyNumber,
                father: father,
                mother: mother,
                children: children,
                lastName: father?.×©×_××©×¤×—×” || mother?.×©×_××©×¤×—×”,
                marriageDate: father?.×ª××¨×™×š_× ×©×•××™×Ÿ
            };
        }

        async function searchFamilyByName() {
            // ×—×™×¤×•×© ××©×¤×—×” ×œ×¤×™ ×©× ×”××©×ª××©
            const possibleFathers = allMembers.filter(m => 
                m.×©×_×¤×¨×˜×™ === currentUser.firstName && 
                m.×©×_××©×¤×—×” === currentUser.lastName &&
                m.×¨××©_××©×¤×—×” === 'TRUE'
            );

            if (possibleFathers.length > 0) {
                return await buildFamilyStructure(possibleFathers[0].××©×¤_×¢×¦××™);
            }

            // ×—×™×¤×•×© ×›×™×œ×“ ×‘××©×¤×—×”
            const possibleChildren = allMembers.filter(m => 
                m.×©×_×¤×¨×˜×™ === currentUser.firstName && 
                m.××©×¤_×”×•×¨×™×
            );

            if (possibleChildren.length > 0) {
                return await buildFamilyStructure(possibleChildren[0].××©×¤_×”×•×¨×™×);
            }

            return null;
        }

        function displayUserFamily() {
            const familyContent = document.getElementById('familyContent');

            if (!userFamily) {
                familyContent.innerHTML = `
                    <div class="message warning">
                        <h3>âš ï¸ ××©×¤×—×” ×œ× × ××¦××”</h3>
                        <p>×œ× ×”×¦×œ×—× ×• ×œ××¦×•× ××ª ×”××©×¤×—×” ×©×œ×š ×‘××¢×¨×›×ª.</p>
                        <p>×× × ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª ×œ×‘×™×¨×•×¨.</p>
                        <p><strong>×¤×¨×˜×™×š:</strong> ${currentUser.firstName} ${currentUser.lastName}</p>
                    </div>
                `;
                return;
            }

            familyContent.innerHTML = `
                <div class="family-card">
                    <div class="family-header">
                        <div class="family-title">××©×¤×—×ª ${userFamily.lastName}</div>
                        <div class="family-number">××©×¤×—×” ${userFamily.familyNumber}</div>
                    </div>

                    <div class="parents-section">
                        <div class="parent-card father">
                            <div class="parent-name">ğŸ‘¨ ${userFamily.father ? userFamily.father.×©×_×¤×¨×˜×™ : '×œ× ××•×’×“×¨'}</div>
                            <div class="parent-details">
                                ${userFamily.father ? `
                                    ××¡×¤×¨: ${userFamily.father.××¡×¤×¨_××™×©×™}<br>
                                    ${userFamily.father.×ª××¨×™×š_×œ×™×“×” ? `× ×•×œ×“: ${userFamily.father.×ª××¨×™×š_×œ×™×“×”}<br>` : ''}
                                    ${userFamily.father.×©×_×× ? `×‘×Ÿ ${userFamily.father.×©×_××}` : ''}
                                ` : '××™×Ÿ ××™×“×¢'}
                            </div>
                        </div>

                        <div class="parent-card mother">
                            <div class="parent-name">ğŸ‘© ${userFamily.mother ? userFamily.mother.×©×_×¤×¨×˜×™ : '×œ× ××•×’×“×¨'}</div>
                            <div class="parent-details">
                                ${userFamily.mother ? `
                                    ××¡×¤×¨: ${userFamily.mother.××¡×¤×¨_××™×©×™}<br>
                                    ${userFamily.mother.×ª××¨×™×š_×œ×™×“×” ? `× ×•×œ×“×”: ${userFamily.mother.×ª××¨×™×š_×œ×™×“×”}<br>` : ''}
                                    ${userFamily.mother.×©×_×× ? `×‘×ª ${userFamily.mother.×©×_××}` : ''}
                                ` : '××™×Ÿ ××™×“×¢'}
                            </div>
                        </div>
                    </div>

                    ${userFamily.marriageDate ? `
                        <div style="text-align: center; margin-bottom: 20px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                            ğŸ’’ <strong>×ª××¨×™×š ×—×ª×•× ×”:</strong> ${userFamily.marriageDate}
                        </div>
                    ` : ''}

                    <div class="children-section">
                        <div class="children-header">
                            <div class="children-title">ğŸ‘¶ ×”×™×œ×“×™× (${userFamily.children.length})</div>
                            <button class="add-child-btn" onclick="openAddChildModal()">
                                â• ×”×•×¡×£ ×™×œ×“
                            </button>
                        </div>
                        
<button onclick="quickTest()" style="position: fixed; top: 60px; right: 20px; background: #2196F3; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; z-index: 1000;">
    ğŸ§ª ×‘×“×™×§×” ××”×™×¨×”
</button>
                        <div class="children-list">
                            ${userFamily.children.length > 0 ? 
                                userFamily.children.map(child => createChildCard(child)).join('') :
                                '<div style="text-align: center; color: #666; padding: 20px;">××™×Ÿ ×™×œ×“×™× ×¨×©×•××™×</div>'
                            }
                        </div>
                    </div>
                </div>

                <span class="text-xs" id="formError"></span>
            `;
        }

        function createChildCard(child) {
            const benBat = child.××™×Ÿ === '×–×›×¨' ? '×‘×Ÿ' : '×‘×ª';
            const motherName = child.×©×_×× || userFamily.mother?.×©×_×¤×¨×˜×™ || '';
            const fullChildName = motherName ? `${child.×©×_×¤×¨×˜×™} ${benBat} ${motherName}` : child.×©×_×¤×¨×˜×™;
            
            const isApproved = child.×××•×©×¨ !== '×××ª×™×Ÿ ×œ××™×©×•×¨';
            
            return `
                <div class="child-item ${isApproved ? 'approved' : 'pending'}">
                    <div class="child-info">
                        <div class="child-name">
                            ${child.××¡×¤×¨_×‘×Ÿ ? `${child.××¡×¤×¨_×‘×Ÿ}. ` : ''}${fullChildName}
                        </div>
                        <div class="child-details">
                            ${child.××™×Ÿ} â€¢ ××¡×¤×¨ ${child.××¡×¤×¨_××™×©×™}
                            ${child.×ª××¨×™×š_×œ×™×“×” ? ` â€¢ ${child.×ª××¨×™×š_×œ×™×“×”}` : ''}
                            ${child.×”×¢×¨×” ? ` â€¢ ${child.×”×¢×¨×”}` : ''}
                        </div>
                    </div>
                    <div class="child-status ${isApproved ? 'status-approved' : 'status-pending'}">
                        ${isApproved ? 'âœ… ×××•×©×¨' : 'â³ ×××ª×™×Ÿ ×œ××™×©×•×¨'}
                    </div>
                </div>
            `;
        }

        async function loadPendingChildren() {
            try {
                const pendingData = await readFromGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.PENDING_CHILDREN);
                
                const userPendingChildren = pendingData.filter(row => 
                    parseInt(row[6]) === parseInt(userFamily.familyNumber) // ×¢××•×“×ª ××¡×¤×¨ ××©×¤×—×”
                );

                if (userPendingChildren.length === 0) {
                    return '';
                }

                return `
                    <div class="family-card" style="margin-top: 20px; border-color: #ff9800;">
                        <div class="family-header">
                            <div class="family-title" style="color: #ff6f00;">×™×œ×“×™× ×××ª×™× ×™× ×œ××™×©×•×¨</div>
                        </div>

                        <div class="children-list">
                            ${userPendingChildren.map(child => `
                                <div class="child-item pending">
                                    <div class="child-info">
                                        <div class="child-name">${child[0]} ${child[1]}</div>
                                        <div class="child-details">
                                            ${child[2]} â€¢ ${child[3] || '×œ× ××•×’×“×¨ ×ª××¨×™×š ×œ×™×“×”'}
                                            ${child[4] ? ` â€¢ ${child[4]}` : ''}
                                        </div>
                                    </div>
                                    <div class="child-status status-pending">
                                        â³ ×××ª×™×Ÿ ×œ××™×©×•×¨
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×™×œ×“×™× ×××ª×™× ×™×:', error);
                return '';
            }
        }

        // ===== ×”×•×¡×¤×ª ×™×œ×“ =====
        function openAddChildModal() {
            document.getElementById('addChildModal').style.display = 'flex';
            
            // ××™×œ×•×™ ××•×˜×•××˜×™ ×©×œ ×©× ×”××
            const motherName = userFamily.mother?.×©×_×¤×¨×˜×™ || '';
            document.getElementById('childMotherName').value = motherName;
        }

        async function saveChild() {
            const firstName = document.getElementById('childFirstName').value.trim();
            const gender = document.getElementById('childGender').value;
            const birthDate = document.getElementById('childBirthDate').value.trim();
            const motherName = document.getElementById('childMotherName').value.trim();
            const notes = document.getElementById('childNotes').value.trim();

            // ×•×™×“×•× ×©×“×•×ª ×—×•×‘×”
            if (!firstName || !gender) {
                showMessage('error', '×™×© ×œ××œ× ×©× ×¤×¨×˜×™ ×•××™×Ÿ', 'childMessage');
                return;
            }

            try {
                showMessage('info', '×©×•××¨ ×™×œ×“...', 'childMessage');

                // ×—×™×©×•×‘ ××¡×¤×¨ ×”×™×œ×“ ×”×‘× ×‘×¡×“×¨
                const maxChildNumber = userFamily.children.reduce((max, child) => {
                    const num = parseInt(child.××¡×¤×¨_×‘×Ÿ) || 0;
                    return num > max ? num : max;
                }, 0);

                const nextChildNumber = maxChildNumber + 1;

                // ×”×›× ×ª ×”× ×ª×•× ×™×
                const childData = [
                    firstName,
                    userFamily.lastName,
                    gender,
                    birthDate,
                    notes,
                    motherName,
                    userFamily.familyNumber,
                    nextChildNumber,
                    new Date().toISOString(),
                    '×××ª×™×Ÿ ×œ××™×©×•×¨'
                ];

                // ×©××™×¨×” ×‘×’×™×œ×™×•×Ÿ ×™×œ×“×™× ×××ª×™× ×™×
                await writeToGoogleSheets(GOOGLE_SHEETS_CONFIG.RANGES.PENDING_CHILDREN, [childData]);

                showMessage('success', 
                    `×”×™×œ×“ ${firstName} × ×•×¡×£ ×‘×”×¦×œ×—×”!<br>×”×•× ×××ª×™×Ÿ ×›×¢×ª ×œ××™×©×•×¨ ×”×× ×”×œ.`, 
                    'childMessage'
                );

                // × ×™×§×•×™ ×”×˜×•×¤×¡
                document.getElementById('childFirstName').value = '';
                document.getElementById('childGender').value = '';
                document.getElementById('childBirthDate').value = '';
                document.getElementById('childNotes').value = '';

                // ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×” ××—×¨×™ 2 ×©× ×™×•×ª
                setTimeout(async () => {
                    closeModal();
                    await loadUserDashboard();
                }, 2000);

            } catch (error) {
                console.error('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×™×œ×“:', error);
                showMessage('error', '×©×’×™××” ×‘×©××™×¨×ª ×”×™×œ×“. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 'childMessage');
            }
        }

        async function sendVerificationEmail(email, firstName) {
    try {
        console.log(`×©×•×œ×— ××™×™×œ ××™××•×ª ×œ-${email} ×¢×‘×•×¨ ${firstName}`);
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'sendEmail',
                email: email,
                firstName: firstName,
                subject: '××™××•×ª ×›×ª×•×‘×ª ××™×™×œ - ×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ',
                message: `×©×œ×•× ${firstName},\n\n×ª×•×“×” ×¢×œ ×”×¨×©××ª×š ×œ××¢×¨×›×ª ×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ.\n×‘×§×©×ª×š ×”×ª×§×‘×œ×” ×•×ª×˜×•×¤×œ ×‘×”×§×“×.\n\n×‘×‘×¨×›×”,\n×¦×•×•×ª ×›×•×œ×œ×•×ª ×¦×¢×˜×™×œ`
            })
        });

        console.log('âœ… ××™×™×œ × ×©×œ×— ×‘×”×¦×œ×—×”');
        return { success: true };
        
    } catch (error) {
        console.error('âš ï¸ ×©×’×™××” ×‘×©×œ×™×—×ª ××™×™×œ:', error);
        // ××œ ×ª×¢×¦×•×¨ ××ª ×”×ª×”×œ×™×š ×‘×’×œ×œ ×©×’×™××ª ××™×™×œ
        return { success: false, error: error.message };
    }
}

async function testGoogleAppsScript() {
    try {
        console.log('ğŸ”„ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ-Google Apps Script...');
        
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'GET', // ×‘×“×™×§×” ×¤×©×•×˜×” ×¢× GET
            mode: 'no-cors'
        });
        
        console.log('âœ… ×—×™×‘×•×¨ ×œ-Google Apps Script ×¢×•×‘×“');
        return true;
        
    } catch (error) {
        console.error('âŒ ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ-Google Apps Script:', error);
        return false;
    }
}
        // ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ =====
        function showMessage(type, message, elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // ×”×¡×¨×ª ×”×”×•×“×¢×” ××—×¨×™ 10 ×©× ×™×•×ª
            setTimeout(() => {
                element.innerHTML = '';
            }, 10000);
        }

        function closeModal() {
            document.getElementById('addChildModal').style.display = 'none';
            
            // × ×™×§×•×™ ×”×•×“×¢×•×ª
            document.getElementById('childMessage').innerHTML = '';
        }

        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                localStorage.removeItem('familyUser');
                currentUser = null;
                userFamily = null;
                
                // ×—×–×¨×” ×œ××¡×š ×”×ª×—×‘×¨×•×ª
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('familyDashboard').style.display = 'none';
                
                // × ×™×§×•×™ ×˜×¤×¡×™×
                document.getElementById('loginForm').reset();
                document.querySelectorAll('#registerForm input, #registerForm select, #registerForm textarea').forEach(input => input.value = '');
                
                showLoginForm();
            }
        }

        // ===== ×”××–× ×” ×œ××™×¨×•×¢×™× =====
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // ×¡×’×™×¨×ª ××•×“×œ ×¢× ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ×•×™×“×•× ××¡×¤×¨×™× ×‘×œ×‘×“ ×‘×ª.×–.
        document.getElementById('regId')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });

        document.getElementById('loginId')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
       
    </script>
</body>
</html>
